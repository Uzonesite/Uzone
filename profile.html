<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uzone Profile</title>
  <link rel="icon" type="image/png" href="logo1.png">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: #0f0f14;
      color: white;
      padding: 30px;
    }

    .back {
      color: #b00b55;
      margin-bottom: 20px;
      cursor: pointer;
      font-weight: 600;
    }

    .container {
      max-width: 500px;
      margin: auto;
      background: #1b1b25;
      padding: 30px;
      border-radius: 20px;
    }

    h2 {
      color: #b00b55;
      margin-bottom: 20px;
      text-align: center;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 10px;
      border: none;
      background: #2a2a35;
      color: white;
    }

    textarea {
      resize: none;
      height: 80px;
    }

    .pictures input {
      margin-bottom: 10px;
    }

    .save-btn {
      width: 100%;
      padding: 12px;
      background: #b00b55;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      color: white;
      cursor: pointer;
    }

    .save-btn:hover {
      background: #920946;
    }

    .preview img {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 10px;
    }

  </style>
</head>

<body>

<div class="back" onclick="window.location.href='hub.html'">‚Üê Back</div>

<div class="container">
  <h2>Your Profile</h2>

  <input type="text" id="name" placeholder="Name">
  <input type="number" id="age" placeholder="Age">
  <textarea id="bio" placeholder="Bio"></textarea>
  <input type="text" id="school" placeholder="School">
  <input type="text" id="program" placeholder="Program">

  <div class="pictures">
    <input type="file" id="pic0" accept="image/*">
    <input type="file" id="pic1" accept="image/*">
    <input type="file" id="pic2" accept="image/*">
  </div>

  <div class="preview" id="preview"></div>

  <button class="save-btn" onclick="saveProfile()">Save Profile</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, set, get } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyD_k18vbiBsLhQB7PzgEVT9PEI_30Mu0kg",
  authDomain: "uzone-6148d.firebaseapp.com",
  databaseURL: "https://uzone-6148d-default-rtdb.firebaseio.com",
  projectId: "uzone-6148d",
  storageBucket: "uzone-6148d.firebasestorage.app",
  messagingSenderId: "88783701381",
  appId: "1:88783701381:web:4f6c4b1ad8b26d6fa6f0ec"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

let currentUser;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    currentUser = user;
    loadProfile();
  }
});

async function loadProfile() {
  const snapshot = await get(ref(db, "users/" + currentUser.uid));
  if (snapshot.exists()) {
    const data = snapshot.val();
    document.getElementById("name").value = data.name || "";
    document.getElementById("age").value = data.age || "";
    document.getElementById("bio").value = data.bio || "";
    document.getElementById("school").value = data.school || "";
    document.getElementById("program").value = data.program || "";

    if (data.pictures) {
      const preview = document.getElementById("preview");
      preview.innerHTML = "";
      Object.values(data.pictures).forEach(url => {
        const img = document.createElement("img");
        img.src = url;
        preview.appendChild(img);
      });
    }
  }
}

window.saveProfile = async function () {

  const name = document.getElementById("name").value;
  const age = document.getElementById("age").value;
  const bio = document.getElementById("bio").value;
  const school = document.getElementById("school").value;
  const program = document.getElementById("program").value;

  let pictures = {};

  for (let i = 0; i < 3; i++) {
    const fileInput = document.getElementById("pic" + i);
    if (fileInput.files[0]) {
      const file = fileInput.files[0];
      const imgRef = storageRef(storage, "users/" + currentUser.uid + "/pic" + i);
      await uploadBytes(imgRef, file);
      const url = await getDownloadURL(imgRef);
      pictures[i] = url;
    }
  }

  const existing = await get(ref(db, "users/" + currentUser.uid));
  let existingPics = existing.exists() && existing.val().pictures ? existing.val().pictures : {};

  const finalPics = { ...existingPics, ...pictures };

  await set(ref(db, "users/" + currentUser.uid), {
    name,
    age,
    bio,
    school,
    program,
    pictures: finalPics
  });

  alert("Profile Saved!");
  loadProfile();
}
</script>

</body>
</html>
