<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Uzone • My Motives</title>

  <link rel="icon" type="image/png" href="logo.png" />
  <meta name="color-scheme" content="dark light" />

  <style>
    :root{
      --accent:#b00b55;
      --bg:#0b0b10;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100dvh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(176,11,85,.30), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(176,11,85,.18), transparent 55%),
        radial-gradient(700px 500px at 50% 90%, rgba(255,255,255,.06), transparent 60%),
        var(--bg);
    }

    header{
      width:min(1120px, 92vw);
      margin:18px auto 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 10;
      backdrop-filter: blur(10px);
    }
    .left{display:flex; align-items:center; gap:12px; min-width:0;}
    .left img{
      width:38px;height:38px;object-fit:contain;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.35));
    }
    .title{display:grid; gap:2px; min-width:0;}
    .title h1{margin:0;font-size:18px;letter-spacing:.2px}
    .title .sub{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    /* Buttons: match events page "glassy + accent glow" behavior */
    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, filter .12s ease, background .12s ease;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: var(--accent);
      box-shadow: 0 0 16px var(--accent), 0 16px 40px rgba(176,11,85,.30);
      filter: brightness(1.06);
    }
    .btn:active{
      transform: translateY(0px) scale(.99);
      box-shadow: 0 0 10px var(--accent), 0 10px 28px rgba(176,11,85,.20);
      filter: brightness(1.0);
    }
    .btn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 4px rgba(176,11,85,.26), 0 0 18px var(--accent);
    }
    .btn:disabled{opacity:.65;cursor:not-allowed}

    /* Primary accent button */
    .btn.primary{
      border:1px solid rgba(176,11,85,.55);
      background: linear-gradient(135deg, rgba(176,11,85,.95), rgba(176,11,85,.58));
      color:white;
      box-shadow: 0 18px 40px rgba(176,11,85,.22);
    }
    .btn.primary:hover{
      border-color: var(--accent);
      box-shadow: 0 0 20px var(--accent), 0 22px 55px rgba(176,11,85,.35);
      filter: brightness(1.08);
    }
    .btn.primary:active{
      box-shadow: 0 0 14px var(--accent), 0 14px 34px rgba(176,11,85,.20);
    }

    main{
      width:min(1120px, 92vw);
      margin:14px auto 60px auto;
      display:grid;
      gap:14px;
    }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .toolbar{
      padding:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
    }

    .searchWrap{
      display:flex;
      gap:10px;
      align-items:center;
      flex:1;
      min-width: 240px;
    }
    input[type="search"]{
      width:100%;
      max-width:520px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline: none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    input[type="search"]:focus{
      border-color: rgba(176,11,85,.65);
      box-shadow: 0 0 0 4px rgba(176,11,85,.12);
    }

    .chips{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.90);
      font-size:12px;
      font-weight:900;
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:50%; background: rgba(176,11,85,.9); box-shadow: 0 0 0 4px rgba(176,11,85,.12);}

    .sectionHead{
      padding:14px 14px 0 14px;
      display:flex;
      align-items:end;
      justify-content:space-between;
      gap:12px;
    }
    .sectionHead h2{
      margin:0;
      font-size:15px;
      letter-spacing:.2px;
    }
    .sectionHead .muted{
      color:var(--muted);
      font-size:12px;
    }

    .grid{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 620px){
      .grid{ grid-template-columns: 1fr; }
      header{ position: static; }
    }

    .event{
      padding:14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, filter .12s ease;
      display:grid;
      gap:10px;
    }
    .event:hover{
      transform: translateY(-1px);
      border-color: rgba(176,11,85,.55);
      box-shadow: 0 0 0 4px rgba(176,11,85,.10), 0 18px 50px rgba(0,0,0,.35);
      filter: brightness(1.04);
    }
    .eventTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .eventTitle{margin:0; font-size:15px; font-weight:950; letter-spacing:.2px;}
    .badge{
      padding:6px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-size:11px;
      font-weight:950;
      white-space:nowrap;
    }
    .badge.invite{
      border-color: rgba(176,11,85,.55);
      background: rgba(176,11,85,.12);
    }
    .meta{
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
      display:grid;
      gap:4px;
    }
    .meta b{color: rgba(255,255,255,.88); font-weight:900;}
    .desc{
      font-size:12.5px;
      color: rgba(255,255,255,.84);
      line-height: 1.35;
      opacity: .95;
      display:-webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:4px;
    }
    .actions .leftA{display:flex; gap:10px; flex-wrap:wrap;}
    .mini{
      padding:9px 11px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color: rgba(255,255,255,.92);
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, filter .12s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      font-size:12px;
    }
    .mini:hover{
      transform: translateY(-1px);
      border-color: var(--accent);
      box-shadow: 0 0 14px rgba(176,11,85,.55), 0 0 0 4px rgba(176,11,85,.10);
      filter: brightness(1.06);
    }
    .mini:active{
      transform: translateY(0px) scale(.99);
      box-shadow: 0 0 10px rgba(176,11,85,.45), 0 0 0 4px rgba(176,11,85,.08);
      filter: brightness(1.0);
    }
    .mini:focus-visible{
      outline:none;
      box-shadow: 0 0 0 4px rgba(176,11,85,.22), 0 0 14px rgba(176,11,85,.55);
    }

    .list{
      padding:14px;
      display:grid;
      gap:10px;
    }
    .req{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding:12px;
      display:grid;
      gap:10px;
    }
    .reqTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .reqTitle{
      margin:0;
      font-size:13px;
      font-weight:950;
    }
    .reqMeta{
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .reqBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .mini.ok{
      border-color: rgba(90, 255, 170, .35);
      background: rgba(90, 255, 170, .10);
    }
    .mini.ok:hover{
      box-shadow: 0 0 0 4px rgba(90, 255, 170, .10);
      border-color: rgba(90, 255, 170, .55);
    }
    .mini.no{
      border-color: rgba(255, 90, 120, .35);
      background: rgba(255, 90, 120, .10);
    }
    .mini.no:hover{
      box-shadow: 0 0 0 4px rgba(255, 90, 120, .10);
      border-color: rgba(255, 90, 120, .55);
    }

    .empty{
      padding:16px;
      color: var(--muted);
      display:none;
    }
    .msg{
      margin: 0 14px 14px 14px;
      display:none;
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.88);
      font-size:13px;
    }
    .msg.bad{
      border-color: rgba(255, 90, 120, .40);
      background: rgba(255, 90, 120, .10);
    }
    .msg.good{
      border-color: rgba(90, 255, 170, .35);
      background: rgba(90, 255, 170, .10);
    }
  </style>
</head>

<body>
  <header>
    <div class="left">
      <img src="logo.png" alt="Uzone" />
      <div class="title">
        <h1>My Motives</h1>
        <div class="sub" id="subline">Loading…</div>
      </div>
    </div>

    <div class="right">
      <a class="btn" href="hub.html">← Hub</a>
      <a class="btn" href="events.html">Explore</a>
      <a class="btn primary" href="post_event.html">+ Post</a>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="toolbar">
        <div class="searchWrap">
          <input id="search" type="search" placeholder="Search your motives (name, tags, location, description)…" />
          <button class="btn" id="refreshBtn" type="button">Refresh</button>
        </div>
        <div class="chips">
          <span class="chip" id="countChip"><span class="dot"></span><span id="countText">0</span> motives</span>
          <span class="chip" id="reqChip" style="display:none;"><span class="dot"></span><span id="reqText">0</span> invite requests</span>
        </div>
      </div>

      <div class="sectionHead">
        <div>
          <h2>Your motives</h2>
          <div class="muted">These are events you posted (across older + newer field versions).</div>
        </div>
        <div class="muted" id="hintText"></div>
      </div>

      <div class="msg" id="msg"></div>
      <div class="empty" id="emptyMine">No motives found.</div>
      <div class="grid" id="mineGrid"></div>
    </section>

    <section class="card" id="reqCard" style="display:none;">
      <div class="sectionHead">
        <div>
          <h2>Invite requests</h2>
          <div class="muted">Pending applications for your invite-only motives.</div>
        </div>
        <div class="muted" id="reqSub">—</div>
      </div>

      <div class="msg" id="reqMsg"></div>
      <div class="empty" id="emptyReq">No pending requests.</div>
      <div class="list" id="reqList"></div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getFirestore,
      collection, doc,
      getDocs, getDoc,
      query, where,
      setDoc, updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD_k18vbiBsLhQB7PzgEVT9PEI_30Mu0kg",
      authDomain: "uzone-6148d.firebaseapp.com",
      projectId: "uzone-6148d",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const subline = document.getElementById("subline");
    const msg = document.getElementById("msg");
    const mineGrid = document.getElementById("mineGrid");
    const emptyMine = document.getElementById("emptyMine");
    const searchEl = document.getElementById("search");
    const refreshBtn = document.getElementById("refreshBtn");
    const countText = document.getElementById("countText");
    const hintText = document.getElementById("hintText");

    const reqCard = document.getElementById("reqCard");
    const reqList = document.getElementById("reqList");
    const reqChip = document.getElementById("reqChip");
    const reqText = document.getElementById("reqText");
    const reqSub = document.getElementById("reqSub");
    const reqMsg = document.getElementById("reqMsg");
    const emptyReq = document.getElementById("emptyReq");

    let currentUser = null;
    let allMine = [];         // full event objects
    let allRequests = [];     // aggregated pending requests

    function showMsg(el, text, kind=""){
      el.className = "msg" + (kind ? " " + kind : "");
      el.style.display = text ? "block" : "none";
      el.textContent = text || "";
    }
    function setTopMsg(text, kind=""){ showMsg(msg, text, kind); }
    function setReqMsg(text, kind=""){ showMsg(reqMsg, text, kind); }

    function safeStr(v){ return (v == null) ? "" : String(v); }
    function lower(v){ return safeStr(v).toLowerCase(); }

    function pickDescription(d){
      return safeStr(d.description || d.desc || d.bio || d.about || "");
    }

    function pickCreatedAtMs(d){
      // Firestore Timestamp: {seconds, nanoseconds} OR Date OR number OR string
      const t = d.createdAt || d.updatedAt || d.timeCreated || null;
      if (!t) return 0;
      if (typeof t === "number") return t;
      if (typeof t === "string"){
        const ms = Date.parse(t);
        return Number.isFinite(ms) ? ms : 0;
      }
      if (t?.toDate) return t.toDate().getTime();
      if (typeof t?.seconds === "number") return (t.seconds * 1000);
      return 0;
    }

    function fmtWhen(d){
      const sd = safeStr(d.startDate);
      const st = safeStr(d.startTime);
      const ed = safeStr(d.endDate);
      const et = safeStr(d.endTime);
      const start = [sd, st].filter(Boolean).join(" ");
      const end = [ed, et].filter(Boolean).join(" ");
      if (start && end) return `${start} → ${end}`;
      return start || end || "—";
    }

    function esc(s){
      return safeStr(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderMine(){
      const q = lower(searchEl.value.trim());
      let filtered = allMine;

      if (q){
        filtered = allMine.filter(e => {
          const hay = [
            e.name, e.location, (e.tags || []).join(" "),
            pickDescription(e),
            e.hostName, e.hostUid, e.ownerUid
          ].map(lower).join(" | ");
          return hay.includes(q);
        });
      }

      countText.textContent = String(filtered.length);
      mineGrid.innerHTML = "";

      emptyMine.style.display = (filtered.length === 0) ? "block" : "none";

      for (const e of filtered){
        const isInvite = !!e.inviteOnly;
        const desc = pickDescription(e);
        const tags = Array.isArray(e.tags) ? e.tags : [];
        const tagLine = tags.length ? tags.slice(0,3).join(", ") : "—";
        const when = fmtWhen(e);

        const el = document.createElement("div");
        el.className = "event";
        el.innerHTML = `
          <div class="eventTop">
            <h3 class="eventTitle">${esc(e.name || "Untitled")}</h3>
            <span class="badge ${isInvite ? "invite" : ""}">${isInvite ? "Invite-only" : "Public"}</span>
          </div>

          <div class="meta">
            <div><b>When:</b> ${esc(when)}</div>
            <div><b>Where:</b> ${esc(e.location || "—")}</div>
            <div><b>Tags:</b> ${esc(tagLine)}</div>
          </div>

          ${desc ? `<div class="desc">${esc(desc)}</div>` : ""}

          <div class="actions">
            <div class="leftA">
              <a class="mini" href="event.html?id=${encodeURIComponent(e.id)}">Open</a>
              <button class="mini" type="button" data-copy="${esc(e.id)}">Copy link</button>
            </div>
            
          </div>
        `;
        mineGrid.appendChild(el);
      }

      // Wire copy buttons
      mineGrid.querySelectorAll('button[data-copy]').forEach(btn => {
        btn.addEventListener("click", async () => {
          try{
            const id = btn.getAttribute("data-copy");
            const url = `${location.origin}${location.pathname.replace(/[^/]*$/, "")}event.html?id=${encodeURIComponent(id)}`;
            await navigator.clipboard.writeText(url);
            setTopMsg("Copied event link.", "good");
            setTimeout(() => setTopMsg(""), 1200);
          }catch{
            setTopMsg("Couldn’t copy (browser blocked clipboard).", "bad");
          }
        });
      });
    }

    async function loadMine(uid){
      // IMPORTANT: no orderBy here -> avoids composite index requirements.
      const fields = ["hostUid","ownerUid","createdBy","creatorUid","uid"];
      const seen = new Map();

      for (const f of fields){
        try{
          const qy = query(collection(db, "events"), where(f, "==", uid));
          const snap = await getDocs(qy);
          snap.forEach(docSnap => {
            if (!seen.has(docSnap.id)){
              seen.set(docSnap.id, { id: docSnap.id, ...docSnap.data() });
            }
          });
        }catch(err){
          console.warn("Query failed for field:", f, err);
        }
      }

      const arr = Array.from(seen.values());
      arr.sort((a,b) => pickCreatedAtMs(b) - pickCreatedAtMs(a));

      allMine = arr;
      renderMine();

      hintText.textContent = allMine.length
        ? `Showing your newest motives first.`
        : `No events matched your user yet.`;

      return allMine;
    }

    async function loadInviteRequests(uid){
      // Aggregate pending applications across inviteOnly events you host.
      allRequests = [];
      reqList.innerHTML = "";
      emptyReq.style.display = "none";
      reqChip.style.display = "none";
      reqCard.style.display = "none";
      setReqMsg("");

      const inviteMine = allMine.filter(e => !!e.inviteOnly);
      if (!inviteMine.length){
        reqSub.textContent = "No invite-only motives.";
        return;
      }

      // Be reasonable: only scan the newest 40 invite-only motives to avoid too many reads.
      const scan = inviteMine.slice(0, 40);

      let total = 0;

      for (const ev of scan){
        try{
          const appsQ = query(
            collection(db, "events", ev.id, "applications"),
            where("status", "==", "pending")
          );
          const snap = await getDocs(appsQ);
          snap.forEach(d => {
            total++;
            allRequests.push({
              eventId: ev.id,
              eventName: ev.name || "Untitled",
              eventWhen: fmtWhen(ev),
              eventLocation: ev.location || "—",
              applicantUid: d.id,
              ...d.data()
            });
          });
        }catch(err){
          console.warn("Failed reading applications for", ev.id, err);
        }
      }

      reqText.textContent = String(total);

      if (total > 0){
        reqChip.style.display = "inline-flex";
        reqCard.style.display = "block";
        reqSub.textContent = `Pending across ${scan.length} invite-only motives (scanned).`;
      }else{
        reqCard.style.display = "block";
        emptyReq.style.display = "block";
        reqSub.textContent = `No pending requests found (scanned ${scan.length}).`;
        return;
      }

      // Render
      reqList.innerHTML = "";
      allRequests.sort((a,b) => (pickCreatedAtMs(b) - pickCreatedAtMs(a)));

      for (const r of allRequests){
        const el = document.createElement("div");
        el.className = "req";

        const note = safeStr(r.message || r.note || r.reason || "");
        const created =
          r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() :
          (typeof r.createdAt?.seconds === "number" ? new Date(r.createdAt.seconds*1000).toLocaleString() : "");

        el.innerHTML = `
          <div class="reqTop">
            <div>
              <h3 class="reqTitle">${esc(r.eventName)} <span class="badge invite" style="margin-left:8px;">invite-only</span></h3>
              <div class="reqMeta">
                <div><b>Applicant:</b> ${esc(r.applicantName || r.displayName || "User")}</div>
                <div><b>When:</b> ${esc(r.eventWhen)}</div>
                <div><b>Requested:</b> ${esc(created || "—")}</div>
                ${note ? `<div><b>Note:</b> ${esc(note)}</div>` : ""}
              </div>
            </div>
            <div class="reqBtns">
              <button class="mini ok" type="button" data-accept="1">Accept</button>
              <button class="mini no" type="button" data-deny="1">Deny</button>
              <a class="mini" href="event.html?id=${encodeURIComponent(r.eventId)}">Open event</a>
            </div>
          </div>
        `;

        // Wire buttons
        const acceptBtn = el.querySelector("button[data-accept]");
        const denyBtn = el.querySelector("button[data-deny]");

        acceptBtn.addEventListener("click", () => handleDecision(r, "accepted", acceptBtn, denyBtn));
        denyBtn.addEventListener("click", () => handleDecision(r, "denied", acceptBtn, denyBtn));

        reqList.appendChild(el);
      }
    }

    async function handleDecision(r, decision, acceptBtn, denyBtn){
      if (!currentUser) return;
      acceptBtn.disabled = true;
      denyBtn.disabled = true;

      try{
        const appRef = doc(db, "events", r.eventId, "applications", r.applicantUid);

        if (decision === "accepted"){
          // mark as member
          const memRef = doc(db, "events", r.eventId, "members", r.applicantUid);
          await setDoc(memRef, {
            uid: r.applicantUid,
            status: "accepted",
            decidedBy: currentUser.uid,
            decidedAt: serverTimestamp(),
            createdAt: serverTimestamp()
          }, { merge: true });
        }

        await updateDoc(appRef, {
          status: decision,
          decidedBy: currentUser.uid,
          decidedAt: serverTimestamp()
        });

        setReqMsg(decision === "accepted" ? "Accepted request." : "Denied request.", "good");
        setTimeout(() => setReqMsg(""), 1200);

        // Remove from UI quickly (refresh afterwards)
        await refreshAll();
      }catch(err){
        console.error(err);
        setReqMsg(err?.message || "Could not update request (rules/index issue).", "bad");
        acceptBtn.disabled = false;
        denyBtn.disabled = false;
      }
    }

    async function refreshAll(){
      if (!currentUser) return;
      setTopMsg("Loading…");
      await loadMine(currentUser.uid);
      await loadInviteRequests(currentUser.uid);
      setTopMsg("");
    }

    // Events
    refreshBtn.addEventListener("click", refreshAll);
    searchEl.addEventListener("input", renderMine);

    onAuthStateChanged(auth, async (user) => {
      if (!user){
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      subline.textContent = `Signed in as ${user.displayName || "User"}`;

      try{
        await refreshAll();
      }catch(err){
        console.error(err);
        setTopMsg(err?.message || "Failed to load your motives.", "bad");
      }
    });
  </script>
</body>
</html>
