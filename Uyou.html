<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uyou</title>
<link rel="icon" type="image/png" href="logo3.png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Poppins', sans-serif;
}

body {
  background: #0f0f14;
  color: white;
  padding: 30px;
}

.back {
  color: #b00b55;
  margin-bottom: 20px;
  cursor: pointer;
  font-weight: 600;
}

.container {
  max-width: 500px;
  margin: auto;
  background: #1b1b25;
  padding: 30px;
  border-radius: 20px;
}

h2 {
  color: #b00b55;
  margin-bottom: 20px;
  text-align: center;
}

input, textarea {
  width: 100%;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 10px;
  border: none;
  background: #2a2a35;
  color: white;
}

textarea {
  resize: none;
  height: 80px;
}

.upload-btn {
  display: block;
  width: 100%;
  padding: 10px;
  margin-bottom: 8px;
  background: #2a2a35;
  border-radius: 10px;
  text-align: center;
  cursor: pointer;
  transition: 0.2s;
  border: 1px solid #333;
}

.upload-btn:hover {
  border: 1px solid #b00b55;
}

.upload-btn input {
  display: none;
}

.pic-group {
  margin-bottom: 15px;
}

.preview-img {
  width: 100%;
  border-radius: 10px;
  margin-bottom: 10px;
  display: none;
}

.save-btn {
  width: 100%;
  padding: 12px;
  background: #b00b55;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  color: white;
  cursor: pointer;
  transition: 0.2s;
}

.save-btn:hover {
  background: #920946;
}

.save-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.loader {
  display: none;
  text-align: center;
  margin-top: 10px;
}

.spinner {
  border: 3px solid #333;
  border-top: 3px solid #b00b55;
  border-radius: 50%;
  width: 25px;
  height: 25px;
  animation: spin 1s linear infinite;
  margin: auto;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

.verify-section {
  margin-top: 25px;
  padding-top: 15px;
  border-top: 1px solid #333;
}

.verify-badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  display: inline-block;
  margin-bottom: 10px;
}

.verified {
  background: #0f5132;
  color: #4ade80;
}

.not-verified {
  background: #3a1a1f;
  color: #ff4d6d;
}

.pending {
  background: #3a2f10;
  color: #facc15;
}

.save-message {
  display: none;
  text-align: center;
  margin-top: 10px;
  color: #4ade80;
  font-weight: 600;
}
</style>
</head>

<body>

<div class="back" onclick="window.location.href='Uhub.html'">← Back</div>

<div class="container">
<h2>Your Profile</h2>

<div id="verificationStatus"></div>

<input type="text" id="name" placeholder="Name">
<input type="number" id="age" placeholder="Age">
<textarea id="bio" placeholder="Bio"></textarea>
<input type="text" id="school" placeholder="School">
<input type="text" id="program" placeholder="Program">

<h3 style="margin-bottom:10px;">Profile Pictures</h3>

<div class="pic-group">
  <label class="upload-btn">
    Upload Picture 1
    <input type="file" id="pic0" accept="image/*">
  </label>
  <img id="preview0" class="preview-img">
</div>

<div class="pic-group">
  <label class="upload-btn">
    Upload Picture 2
    <input type="file" id="pic1" accept="image/*">
  </label>
  <img id="preview1" class="preview-img">
</div>

<div class="pic-group">
  <label class="upload-btn">
    Upload Picture 3
    <input type="file" id="pic2" accept="image/*">
  </label>
  <img id="preview2" class="preview-img">
</div>

<div class="verify-section">
  <h3 style="margin-bottom:10px;">Student Verification</h3>
  <div id="verifyContent">
    <label class="upload-btn">
      Upload Student Card
      <input type="file" id="studentCard" accept="image/*">
    </label>
    <img id="studentPreview" class="preview-img">
  </div>
</div>

<button class="save-btn" id="saveBtn" onclick="saveProfile()">Save Profile</button>
<div class="save-message" id="saveMessage">✔ Saved</div>

<div class="loader" id="loader">
  <div class="spinner"></div>
  <p style="margin-top:8px;">Saving...</p>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, set, get } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyD_k18vbiBsLhQB7PzgEVT9PEI_30Mu0kg",
  authDomain: "uzone-6148d.firebaseapp.com",
  databaseURL: "https://uzone-6148d-default-rtdb.firebaseio.com",
  projectId: "uzone-6148d",
  storageBucket: "uzone-6148d.firebasestorage.app",
  messagingSenderId: "88783701381",
  appId: "1:88783701381:web:4f6c4b1ad8b26d6fa6f0ec"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

let currentUser;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    currentUser = user;
    loadProfile();
  }
});

// Image previews (profile pics)
for (let i = 0; i < 3; i++) {
  const input = document.getElementById("pic" + i);
  const preview = document.getElementById("preview" + i);

  input.addEventListener("change", function () {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        preview.src = e.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    }
  });
}

// Student card preview
const studentInput = document.getElementById("studentCard");
const studentPreview = document.getElementById("studentPreview");

studentInput.addEventListener("change", function () {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      studentPreview.src = e.target.result;
      studentPreview.style.display = "block";
    };
    reader.readAsDataURL(file);
  }
});

async function loadProfile() {
  const snapshot = await get(ref(db, "users/" + currentUser.uid));
  const verifySection = document.querySelector(".verify-section");
  const statusDiv = document.getElementById("verificationStatus");

  if (snapshot.exists()) {
    const data = snapshot.val();

    document.getElementById("name").value = data.name || "";
    document.getElementById("age").value = data.age || "";
    document.getElementById("bio").value = data.bio || "";
    document.getElementById("school").value = data.school || "";
    document.getElementById("program").value = data.program || "";

    if (data.verified === true) {
      statusDiv.innerHTML = `<div class="verify-badge verified">✔ Verified Student</div>`;
      verifySection.style.display = "none";
    } else if (data.studentCard) {
      statusDiv.innerHTML = `<div class="verify-badge pending">Pending Verification</div>`;
    } else {
      statusDiv.innerHTML = `<div class="verify-badge not-verified">Not Verified</div>`;
    }

    if (data.pictures) {
      for (let i = 0; i < 3; i++) {
        if (data.pictures[i]) {
          const preview = document.getElementById("preview" + i);
          preview.src = data.pictures[i];
          preview.style.display = "block";
        }
      }
    }
  }
}

window.saveProfile = async function () {
  try {
    const saveBtn = document.getElementById("saveBtn");
    const loader = document.getElementById("loader");
    const saveMessage = document.getElementById("saveMessage");

    saveBtn.disabled = true;
    loader.style.display = "block";

    const name = document.getElementById("name").value;
    const age = document.getElementById("age").value;
    const bio = document.getElementById("bio").value;
    const school = document.getElementById("school").value;
    const program = document.getElementById("program").value;

    const snapshot = await get(ref(db, "users/" + currentUser.uid));
    const existingData = snapshot.exists() ? snapshot.val() : {};
    let pictures = existingData.pictures || [];

    for (let i = 0; i < 3; i++) {
      const fileInput = document.getElementById("pic" + i);
      const file = fileInput.files[0];

      if (file) {
        const picRef = storageRef(storage, `profilePics/${currentUser.uid}_${i}`);
        await uploadBytes(picRef, file);
        const downloadURL = await getDownloadURL(picRef);
        pictures[i] = downloadURL;
      }
    }

    await set(ref(db, "users/" + currentUser.uid), {
      ...existingData,
      name,
      age,
      bio,
      school,
      program,
      pictures
    });

    loader.style.display = "none";
    saveBtn.disabled = false;

    saveMessage.style.display = "block";
    setTimeout(() => {
      saveMessage.style.display = "none";
    }, 3000);

    loadProfile();

  } catch (error) {
    console.error("SAVE ERROR:", error);
    alert(error.message);
  }
};


</script>

</body>
</html>
