<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // === Firebase (use your existing config) ===
  const firebaseConfig = {
    apiKey: "AIzaSyD_k18vbiBsLhQB7PzgEVT9PEI_30Mu0kg",
    authDomain: "uzone-6148d.firebaseapp.com",
    projectId: "uzone-6148d",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);

  // === Required elements on the page ===
  // Map container: <div id="map"></div>
  // Places element: <gmp-place-autocomplete id="locationInput"></gmp-place-autocomplete>
  const mapEl = $("map");
  const placeEl = $("locationInput"); // gmp-place-autocomplete
  const pinStatus = $("pinStatus");   // optional
  const postBtn = $("postBtn");       // optional

  // === Optional form fields (rename these ids to match your post_event.html) ===
  const nameEl = $("name");                 // event name input
  const tagsEl = $("tags");                 // tags input (comma list)
  const startDateEl = $("startDate");       // type="date"
  const startTimeEl = $("startTime");       // type="time"
  const endDateEl = $("endDate");           // optional type="date"
  const endTimeEl = $("endTime");           // optional type="time"
  const descEl = $("description");          // textarea
  const inviteOnlyEl = $("inviteOnly");     // checkbox (optional)

  // === Map state ===
  let gmap;
  let marker; // AdvancedMarkerElement
  let picked = { lat: null, lng: null, label: null };

  function setPinStatus(text, ok = false) {
    if (!pinStatus) return;
    pinStatus.textContent = text;
    pinStatus.style.borderColor = ok ? "rgba(80,255,160,.28)" : "rgba(255,80,120,.35)";
  }

  function buildGlowPinEl() {
    // If you already have CSS classes like .glow-pin/.glow-pulse, you can use those instead.
    const wrap = document.createElement("div");
    wrap.style.position = "relative";
    const pulse = document.createElement("div");
    pulse.style.position = "absolute";
    pulse.style.width = "46px";
    pulse.style.height = "46px";
    pulse.style.borderRadius = "999px";
    pulse.style.border = "2px solid rgba(176,11,85,.35)";
    pulse.style.transform = "translate(-50%, -50%)";
    pulse.style.left = "0px";
    pulse.style.top = "0px";
    pulse.style.animation = "pulse 1.6s ease-out infinite";

    const dot = document.createElement("div");
    dot.style.width = "16px";
    dot.style.height = "16px";
    dot.style.borderRadius = "999px";
    dot.style.background = "#b00b55";
    dot.style.boxShadow = "0 0 10px #b00b55, 0 0 22px rgba(176,11,85,.75), 0 0 46px rgba(176,11,85,.45)";
    dot.style.transform = "translate(-50%, -50%)";
    dot.style.left = "0px";
    dot.style.top = "0px";
    dot.style.position = "absolute";

    wrap.appendChild(pulse);
    wrap.appendChild(dot);
    return wrap;
  }

  function setPicked(lat, lng, label = null) {
    picked.lat = lat;
    picked.lng = lng;
    picked.label = label;

    const pos = { lat, lng };
    const content = buildGlowPinEl();

    if (!marker) {
      marker = new google.maps.marker.AdvancedMarkerElement({
        map: gmap,
        position: pos,
        content
      });
    } else {
      marker.position = pos;
      marker.content = content;
    }

    gmap.panTo(pos);
    setPinStatus(label ? `Pinned: ${label}` : `Pinned: ${lat.toFixed(5)}, ${lng.toFixed(5)}`, true);
  }

  function clearPicked() {
    picked = { lat: null, lng: null, label: null };
    if (marker) marker.map = null;
    marker = null;
    setPinStatus("No pin selected. Search an address or click the map.", false);
  }

  function whenGoogleReady(timeoutMs = 10000) {
    return new Promise((resolve, reject) => {
      const start = Date.now();
      const tick = () => {
        if (window.google?.maps?.Map) return resolve();
        if (Date.now() - start > timeoutMs) return reject(new Error("Google Maps failed to load."));
        setTimeout(tick, 50);
      };
      tick();
    });
  }

  function parseTags(str) {
    return (str || "")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean)
      .slice(0, 20);
  }

  async function initMap() {
    await whenGoogleReady();

    const defaultCenter = { lat: 45.4215, lng: -75.6972 }; // Ottawa default
    gmap = new google.maps.Map(mapEl, {
      center: defaultCenter,
      zoom: 12,
      // If you have a Map ID, put it here; otherwise remove this line:
      // mapId: "YOUR_MAP_ID",
      clickableIcons: false,
      gestureHandling: "greedy"
    });

    // Click-to-drop-pin
    gmap.addListener("click", (e) => {
      if (!e?.latLng) return;
      setPicked(e.latLng.lat(), e.latLng.lng(), null);
    });

    // Places search (NEW component: gmp-place-autocomplete)
    if (placeEl) {
      placeEl.addEventListener("gmp-select", async (e) => {
        const place = e.place;
        await place.fetchFields({ fields: ["displayName", "formattedAddress", "location"] });
        if (!place.location) return;

        const lat = place.location.lat();
        const lng = place.location.lng();
        const label = place.formattedAddress || place.displayName || null;

        setPicked(lat, lng, label);
        gmap.setZoom(15);
      });
    }

    // Optional: “use my location” button if you have one
    const useMyLocBtn = $("useMyLocBtn");
    if (useMyLocBtn) {
      useMyLocBtn.addEventListener("click", () => {
        if (!navigator.geolocation) return alert("Geolocation not supported.");
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            setPicked(pos.coords.latitude, pos.coords.longitude, "Your location");
            gmap.setZoom(15);
          },
          () => alert("Couldn’t get your location.")
        );
      });
    }

    // Optional: clear pin button if you have one
    const clearPinBtn = $("clearPinBtn");
    if (clearPinBtn) clearPinBtn.addEventListener("click", clearPicked);

    setPinStatus("No pin selected. Search an address or click the map.", false);
  }

  async function postEvent(user) {
    const name = nameEl?.value?.trim() || "";
    const tags = parseTags(tagsEl?.value || "");
    const startDate = startDateEl?.value || "";
    const startTime = startTimeEl?.value || "";
    const endDate = endDateEl?.value || null;
    const endTime = endTimeEl?.value || null;
    const description = descEl?.value?.trim() || null;
    const inviteOnly = !!inviteOnlyEl?.checked;

    if (!name) return alert("Please enter a motive name.");
    if (!startDate || !startTime) return alert("Please choose a start date and time.");
    if (!picked.lat || !picked.lng) return alert("Please search an address or drop a pin on the map.");

    const payload = {
      name,
      tags,
      startDate,
      startTime,
      endDate,
      endTime,
      description,

      // Location fields used by your map viewer page:
      location: picked.label || null,
      lat: picked.lat,
      lng: picked.lng,

      inviteOnly,

      ownerUid: user.uid,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    };

    const ref = await addDoc(collection(db, "events"), payload);
    window.location.href = `event.html?id=${encodeURIComponent(ref.id)}`;
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    await initMap();

    if (postBtn) {
      postBtn.addEventListener("click", async () => {
        postBtn.disabled = true;
        try { await postEvent(user); }
        catch (e) { console.error(e); alert("Failed to post event. Check console + Firestore rules."); }
        finally { postBtn.disabled = false; }
      });
    }
  });
</script>

<style>
/* Pulse keyframes if you used buildGlowPinEl() */
@keyframes pulse{
  0%{opacity:.85; transform: translate(-50%,-50%) scale(.35);}
  100%{opacity:0; transform: translate(-50%,-50%) scale(1.15);}
}
</style>
