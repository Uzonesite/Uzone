<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Uzone • Post Event</title>
<style>
  :root{
    --accent:#b00b55;
    --bg:#0b0b10;
    --panel: rgba(255,255,255,.06);
    --panel2: rgba(255,255,255,.10);
    --border: rgba(255,255,255,.14);
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.70);
    --shadow: 0 20px 60px rgba(0,0,0,.45);
    --radius: 18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100dvh;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 20% 10%, rgba(176,11,85,.30), transparent 60%),
      radial-gradient(900px 600px at 80% 30%, rgba(176,11,85,.18), transparent 55%),
      radial-gradient(700px 500px at 50% 90%, rgba(255,255,255,.06), transparent 60%),
      var(--bg);
  }
  header{
    width:min(1100px, 92vw);
    margin:18px auto 0 auto;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:14px 16px;
    border:1px solid var(--border);
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  .left{display:flex; align-items:center; gap:12px; min-width:0;}
  .left img{width:38px;height:38px;object-fit:contain; filter: drop-shadow(0 8px 16px rgba(0,0,0,.35));}
  .title{display:grid; gap:2px; min-width:0;}
  .title h1{margin:0;font-size:18px;letter-spacing:.2px}
  .title .sub{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}

  .btn{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(176,11,85,.55);
    background: linear-gradient(135deg, rgba(176,11,85,.95), rgba(176,11,85,.58));
    color:white;
    font-weight:750;
    cursor:pointer;
    box-shadow: 0 18px 40px rgba(176,11,85,.22);
    text-decoration:none;
    display:inline-flex; align-items:center; gap:8px;
    white-space:nowrap;
  }
  .btn.secondary{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    box-shadow:none;
    color:rgba(255,255,255,.92);
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}

  main{width:min(1100px, 92vw); margin:16px auto 30px auto; display:grid; gap:14px;}
  .card{
    border:1px solid var(--border);
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding:14px;
  }
  .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
  @media (max-width: 820px){ .row{grid-template-columns:1fr;} }

  label{display:grid; gap:6px; font-size:13px; color:rgba(255,255,255,.78);}
  input, textarea{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color:var(--text);
    outline:none;
    font-size:14px;
  }
  textarea{min-height:140px; resize:vertical}
  input:focus, textarea:focus{
    border-color: rgba(176,11,85,.60);
    box-shadow: 0 0 0 4px rgba(176,11,85,.20);
  }

  .stack{display:grid; gap:12px; align-content:start;}

  /* Image uploader */
  .uploader{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.16);
    border-radius:14px;
    padding:12px;
    display:grid;
    gap:10px;
  }
  .preview{
    width:100%;
    height:160px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    overflow:hidden;
    display:grid;
    place-items:center;
    color: rgba(255,255,255,.65);
    font-size:13px;
  }
  .preview img{width:100%; height:100%; object-fit:cover; display:none;}
  .uploader .mini{
    color: rgba(255,255,255,.70);
    font-size:12px;
    line-height:1.35;
  }
  .fileRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  .fileBtn{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    color:rgba(255,255,255,.92);
    cursor:pointer;
    font-weight:750;
    display:inline-flex; align-items:center; gap:8px;
  }
  .fileName{
    color: rgba(255,255,255,.75);
    font-size:12px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    max-width: 100%;
  }
  .progress{
    height:8px;
    border-radius:999px;
    background: rgba(255,255,255,.10);
    overflow:hidden;
    border:1px solid rgba(255,255,255,.10);
    display:none;
  }
  .progress > div{
    height:100%;
    width:0%;
    background: linear-gradient(135deg, rgba(176,11,85,.95), rgba(176,11,85,.58));
  }

  /* Theme toggle pill for invite-only */
  .togglePill{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    user-select:none;
    cursor:pointer;
  }
  .togglePill .tTitle{display:grid; gap:2px;}
  .togglePill .tTitle b{color: rgba(255,255,255,.92); font-size:13px;}
  .togglePill .tTitle span{color: rgba(255,255,255,.65); font-size:12px; line-height:1.25;}
  .switch{
    width:46px; height:26px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.08);
    position:relative;
    flex:0 0 auto;
  }
  .switch::after{
    content:"";
    width:20px; height:20px;
    border-radius:999px;
    background: rgba(255,255,255,.85);
    position:absolute;
    top:50%;
    left:3px;
    transform: translateY(-50%);
    transition: transform .18s ease, background .18s ease;
  }
  .togglePill.on{
    border-color: rgba(176,11,85,.55);
    box-shadow: 0 0 0 4px rgba(176,11,85,.18);
    background: linear-gradient(180deg, rgba(176,11,85,.18), rgba(0,0,0,.18));
  }
  .togglePill.on .switch{
    border-color: rgba(176,11,85,.55);
    background: rgba(176,11,85,.35);
  }
  .togglePill.on .switch::after{
    transform: translateY(-50%) translateX(20px);
    background: rgba(255,255,255,.92);
  }

  .msg{
    display:none;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.16);
    color:rgba(255,255,255,.85);
    font-size:13px;
    white-space:pre-line;
  }
  .msg.ok{border-color: rgba(80,255,160,.25); background: rgba(80,255,160,.10);}
  .msg.error{border-color: rgba(255,80,120,.30); background: rgba(255,80,120,.10);}
</style>
</head>
<body>
<header>
  <div class="left">
    <img src="logo.png" alt="Uzone logo" />
    <div class="title">
      <h1>Post Event</h1>
      <div class="sub">Create something people actually want to go to</div>
    </div>
  </div>
  <div class="right">
    <a class="btn secondary" href="events.html">← Events</a>
    <a class="btn secondary" href="my_events.html">My Events</a>
    <a class="btn secondary" href="hub.html">Hub</a>
  </div>
</header>

<main>
  <section class="card">
    <div class="row">
      <label>Event Name
        <input id="name" placeholder="e.g., Rooftop Chill Night" />
      </label>
      <label>Location
        <input id="location" placeholder="e.g., 123 King St (or 'Near campus')" />
      </label>
    </div>

    <div class="row" style="margin-top:12px;">
      <label>Date
        <input id="date" placeholder="e.g., 2026-02-22" />
      </label>
      <label>Time
        <input id="time" placeholder="e.g., 9:00 PM" />
      </label>
    </div>

    <!-- NEW: venue size + host spots available -->
    <div class="row" style="margin-top:12px;">
      <label>Venue size (capacity / space)
        <input id="venueSize" placeholder="e.g., small condo / house / 40-person capacity" />
      </label>
      <label>Spots available (host says)
        <input id="spotsAvailable" type="number" min="0" placeholder="e.g., 15" />
      </label>
    </div>

    <div class="row" style="margin-top:12px;">
      <label>Size estimate (# of people)
        <input id="size" type="number" min="1" placeholder="e.g., 20" />
      </label>
      <label>Ratio (guys to girls)
        <input id="ratio" placeholder="e.g., 50/50 or 60/40" />
      </label>
    </div>

    <div class="row" style="margin-top:12px;">
      <label>Vibes
        <input id="vibes" placeholder="e.g., chill, music, games, social" />
      </label>
      <label>Tags (comma separated)
        <input id="tags" placeholder="e.g., no alcohol, music, chill" />
      </label>
    </div>

    <!-- Bio + Image/Invite aligned row -->
    <div class="row" style="margin-top:12px;">
      <label>Event bio
        <textarea id="bio" placeholder="Describe the event…"></textarea>
      </label>

      <div class="stack">
        <div class="uploader">
          <div class="preview" id="preview">
            <img id="previewImg" alt="Event image preview" />
            <div id="previewEmpty">No image selected</div>
          </div>

          <div class="fileRow">
            <input id="imageFile" type="file" accept="image/*" hidden />
            <button class="fileBtn" id="pickImage" type="button">Upload image</button>
            <div class="fileName" id="fileName">PNG/JPG/WebP • max 5MB</div>
          </div>

          <div class="progress" id="progress"><div id="progressBar"></div></div>

          <div class="mini">
            If uploads fail with a “CORS” message, it’s almost always Storage Rules denying the request.
            For now set Storage Rules to allow signed-in users.
          </div>
        </div>

        <input id="inviteOnly" type="checkbox" hidden />
        <div class="togglePill" id="invitePill" role="switch" aria-checked="false" tabindex="0">
          <div class="tTitle">
            <b>Invite-only</b>
            <span>Hide exact date/time/location until you accept applicants.</span>
          </div>
          <div class="switch" aria-hidden="true"></div>
        </div>
      </div>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; margin-top:14px;">
      <button class="btn" id="postBtn" type="button">Post Event</button>
    </div>

    <div class="msg" id="msg"></div>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import {
  getStorage, ref, uploadBytesResumable, getDownloadURL
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyD_k18vbiBsLhQB7PzgEVT9PEI_30Mu0kg",
  authDomain: "uzone-6148d.firebaseapp.com",
  projectId: "uzone-6148d",
  storageBucket: "uzone-6148d.appspot.com"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const msg = document.getElementById("msg");
const postBtn = document.getElementById("postBtn");

const nameEl = document.getElementById("name");
const locationEl = document.getElementById("location");
const dateEl = document.getElementById("date");
const timeEl = document.getElementById("time");

const venueSizeEl = document.getElementById("venueSize");
const spotsAvailableEl = document.getElementById("spotsAvailable");

const sizeEl = document.getElementById("size");
const ratioEl = document.getElementById("ratio");
const vibesEl = document.getElementById("vibes");
const tagsEl = document.getElementById("tags");
const bioEl = document.getElementById("bio");

const imageFileEl = document.getElementById("imageFile");
const pickImageBtn = document.getElementById("pickImage");
const fileNameEl = document.getElementById("fileName");
const previewImg = document.getElementById("previewImg");
const previewEmpty = document.getElementById("previewEmpty");
const progress = document.getElementById("progress");
const progressBar = document.getElementById("progressBar");

const inviteEl = document.getElementById("inviteOnly");
const invitePill = document.getElementById("invitePill");

let currentUser = null;
let selectedFile = null;

function setMsg(text, kind=""){
  msg.style.display = text ? "block" : "none";
  msg.textContent = text || "";
  msg.className = "msg" + (kind ? " " + kind : "");
}

function setInviteUI(){
  const on = !!inviteEl.checked;
  invitePill.classList.toggle("on", on);
  invitePill.setAttribute("aria-checked", on ? "true" : "false");
}
invitePill.addEventListener("click", ()=>{
  inviteEl.checked = !inviteEl.checked;
  setInviteUI();
});
invitePill.addEventListener("keydown", (e)=>{
  if (e.key === "Enter" || e.key === " "){
    e.preventDefault();
    inviteEl.checked = !inviteEl.checked;
    setInviteUI();
  }
});
setInviteUI();

pickImageBtn.addEventListener("click", ()=> imageFileEl.click());

imageFileEl.addEventListener("change", ()=>{
  const f = imageFileEl.files?.[0] || null;
  selectedFile = null;

  if (!f){
    fileNameEl.textContent = "PNG/JPG/WebP • max 5MB";
    previewImg.style.display = "none";
    previewEmpty.style.display = "block";
    previewImg.src = "";
    return;
  }

  if (!f.type.startsWith("image/")){
    setMsg("Please choose an image file.", "error");
    imageFileEl.value = "";
    return;
  }
  if (f.size > 5 * 1024 * 1024){
    setMsg("Image is too large. Max size is 5MB.", "error");
    imageFileEl.value = "";
    return;
  }

  selectedFile = f;
  fileNameEl.textContent = f.name;

  const url = URL.createObjectURL(f);
  previewImg.src = url;
  previewImg.style.display = "block";
  previewEmpty.style.display = "none";
});

function sanitizeExt(filename){
  const ext = (filename.split(".").pop() || "jpg").toLowerCase();
  return ["png","jpg","jpeg","webp"].includes(ext) ? ext : "jpg";
}

async function uploadEventImage(eventId){
  if (!selectedFile) return "";

  progress.style.display = "block";
  progressBar.style.width = "0%";

  const safeExt = sanitizeExt(selectedFile.name);
  const path = `event_images/${eventId}/${Date.now()}.${safeExt}`;
  const storageRef = ref(storage, path);

  // NOTE: if Storage rules deny this, the browser often shows it as “CORS”.
  const task = uploadBytesResumable(storageRef, selectedFile, { contentType: selectedFile.type });

  const url = await new Promise((resolve, reject) => {
    task.on("state_changed",
      (snap) => {
        const pct = (snap.bytesTransferred / snap.totalBytes) * 100;
        progressBar.style.width = `${Math.max(2, Math.min(100, pct))}%`;
      },
      (err) => reject(err),
      async () => resolve(await getDownloadURL(task.snapshot.ref))
    );
  });

  setTimeout(()=>{ progress.style.display = "none"; }, 450);
  return url;
}

onAuthStateChanged(auth, async (user)=>{
  if (!user) { window.location.href="index.html"; return; }
  currentUser = user;
});

postBtn.addEventListener("click", async ()=>{
  if (!currentUser) return;

  const name = (nameEl.value||"").trim();
  if (!name) { setMsg("Please enter an event name.", "error"); return; }

  postBtn.disabled = true;
  setMsg("");

  try{
    // Pull host name from users collection if available
    let hostName = currentUser.displayName || "";
    try{
      const u = await getDoc(doc(db,"users",currentUser.uid));
      if (u.exists() && u.data()?.name) hostName = u.data().name;
    } catch(_) {}

    const tags = (tagsEl.value||"")
      .split(",")
      .map(s=>s.trim())
      .filter(Boolean)
      .slice(0, 12);

    const sizeEstimate = Number(sizeEl.value || 0) || 0;

    const spotsAvailable = Math.max(0, Number(spotsAvailableEl.value || 0) || 0);
    const venueSize = (venueSizeEl.value || "").trim();

    // Create doc first so we have eventId for storage path
    const eventRef = await addDoc(collection(db,"events"), {
      name,
      location: (locationEl.value||"").trim(),
      date: (dateEl.value||"").trim(),
      time: (timeEl.value||"").trim(),

      venueSize,
      spotsAvailable,

      sizeEstimate,
      vibes: (vibesEl.value||"").trim(),
      ratio: (ratioEl.value||"").trim(),
      bio: (bioEl.value||"").trim(),
      tags,

      imageUrl: "",
      inviteOnly: !!inviteEl.checked,

      ratingAvg: 0,
      hostUid: currentUser.uid,
      hostName: hostName || currentUser.email || "Host",
      createdAt: serverTimestamp()
    });

    // Upload image (optional) and patch imageUrl
    try{
      const imageUrl = await uploadEventImage(eventRef.id);
      if (imageUrl){
        await setDoc(doc(db,"events",eventRef.id), { imageUrl }, { merge:true });
      }
    } catch(uploadErr){
      // If this hits and you see “CORS”, your Storage rules are denying the request.
      setMsg(
        `Event posted, but image upload failed.\n\n${uploadErr?.message || uploadErr}\n\nFix: Firebase Storage Rules must allow signed-in users to write to event_images/.`,
        "error"
      );
      setTimeout(()=>{ window.location.href = `event.html?id=${encodeURIComponent(eventRef.id)}`; }, 1200);
      return;
    }

    setMsg("Event posted!", "ok");
    setTimeout(()=>{ window.location.href = `event.html?id=${encodeURIComponent(eventRef.id)}`; }, 600);

  } catch(e){
    setMsg(e?.message || "Failed to post event.", "error");
  } finally {
    postBtn.disabled = false;
  }
});
</script>
</body>
</html>
