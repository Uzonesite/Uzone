<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uzone Dating</title>
<link rel="icon" type="image/png" href="logo3.png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Poppins', sans-serif;
}

body {
  background: #0f0f14;
  color: white;
  padding: 30px;
}

.back {
  color: #b00b55;
  font-weight: 600;
  margin-bottom: 20px;
  cursor: pointer;
}

.card {
  max-width: 400px;
  margin: auto;
  background: #1b1b25;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.images {
  position: relative;
  height: 400px;
  overflow: hidden;
}

.images img {
  width: 100%;
  height: 400px;
  object-fit: cover;
  display: none;
}

.images img.active {
  display: block;
}

.image-nav {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 12px;
  background: rgba(0,0,0,0.5);
  padding: 5px 10px;
  border-radius: 10px;
}

.info {
  padding: 20px;
}

.info h2 {
  color: #b00b55;
  margin-bottom: 5px;
}

.info p {
  font-size: 14px;
  color: #ccc;
  margin-bottom: 6px;
}

.buttons {
  display: flex;
  justify-content: space-around;
  padding: 20px;
}

.btn {
  padding: 10px 25px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

.like {
  background: #b00b55;
  color: white;
}

.dislike {
  background: #333;
  color: white;
}

.matches {
  max-width: 400px;
  margin: 40px auto;
  background: #1b1b25;
  padding: 20px;
  border-radius: 20px;
}

.match-item {
  padding: 10px 0;
  border-bottom: 1px solid #333;
}

.no-users {
  text-align: center;
  margin-top: 50px;
}
</style>
</head>

<body>

<div class="back" onclick="window.location.href='hub.html'">‚Üê Back</div>

<div class="card">
  <div class="images">
    <div class="image-nav" id="imageCounter"></div>
    <img id="pic0">
    <img id="pic1">
    <img id="pic2">
  </div>

  <div class="info">
    <h2 id="nameAge"></h2>
    <p id="bio"></p>
    <p id="school"></p>
    <p id="program"></p>
  </div>

  <div class="buttons">
    <button class="btn dislike" onclick="dislike()">Dislike</button>
    <button class="btn like" onclick="like()">Like</button>
  </div>
</div>

<div id="noUsersMessage" class="no-users" style="display:none;">
  <h2 style="color:#b00b55;">No more users</h2>
  <p style="color:#aaa;">Check back later for new people.</p>
</div>

<div class="matches">
  <h3 style="color:#b00b55;">Your Matches</h3>
  <div id="matchList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, get, set, onValue }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD_k18vbiBsLhQB7PzgEVT9PEI_30Mu0kg",
  authDomain: "uzone-6148d.firebaseapp.com",
  databaseURL: "https://uzone-6148d-default-rtdb.firebaseio.com",
  projectId: "uzone-6148d",
  storageBucket: "uzone-6148d.firebasestorage.app",
  messagingSenderId: "88783701381",
  appId: "1:88783701381:web:4f6c4b1ad8b26d6fa6f0ec"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let users = [];
let currentIndex = 0;
let currentPicIndex = 0;

const card = document.querySelector(".card");
const imagesContainer = document.querySelector(".images");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    currentUser = user;
    await loadUsers();
    loadMatches();
  }
});

/* ---------------- LOAD USERS ---------------- */

async function loadUsers() {
  const snapshot = await get(ref(db, "users"));
  if (!snapshot.exists()) return;

  const likesSnap = await get(ref(db, "likes/" + currentUser.uid));
  const dislikesSnap = await get(ref(db, "dislikes/" + currentUser.uid));

  const liked = likesSnap.exists() ? likesSnap.val() : {};
  const disliked = dislikesSnap.exists() ? dislikesSnap.val() : {};

  users = Object.entries(snapshot.val())
    .filter(([uid]) =>
      uid !== currentUser.uid &&
      !liked?.[uid] &&
      !disliked?.[uid]
    )
    .map(([uid, data]) => ({ uid, ...data }));

  if (users.length === 0) {
    card.style.display = "none";
    document.getElementById("noUsersMessage").style.display = "block";
  } else {
    showUser();
  }
}

/* ---------------- SHOW USER ---------------- */

function showUser() {
  const user = users[currentIndex];
  currentPicIndex = 0;

  updateImages(user);

  document.getElementById("nameAge").innerText =
    user.name + ", " + user.age;
  document.getElementById("bio").innerText = user.bio || "";
  document.getElementById("school").innerText = user.school || "";
  document.getElementById("program").innerText = user.program || "";
}

/* ---------------- IMAGES ---------------- */

function updateImages(user) {
  for (let i = 0; i < 3; i++) {
    const img = document.getElementById("pic" + i);
    img.classList.remove("active");
    img.src = user.pictures?.[i] || "";
  }

  document.getElementById("pic0").classList.add("active");
  updateCounter(user);
}

function updateCounter(user) {
  const total = user.pictures ? Object.keys(user.pictures).length : 1;
  document.getElementById("imageCounter").innerText =
    (currentPicIndex + 1) + " / " + total;
}

function nextImage() {
  const user = users[currentIndex];
  const total = user.pictures ? Object.keys(user.pictures).length : 1;

  if (currentPicIndex < total - 1) {
    document.getElementById("pic" + currentPicIndex).classList.remove("active");
    currentPicIndex++;
    document.getElementById("pic" + currentPicIndex).classList.add("active");
    updateCounter(user);
  }
}

function prevImage() {
  if (currentPicIndex > 0) {
    document.getElementById("pic" + currentPicIndex).classList.remove("active");
    currentPicIndex--;
    document.getElementById("pic" + currentPicIndex).classList.add("active");
    updateCounter(users[currentIndex]);
  }
}

imagesContainer.addEventListener("click", (e) => {
  const width = imagesContainer.clientWidth;
  const clickX = e.offsetX;

  if (clickX > width / 2) nextImage();
  else prevImage();
});

/* ---------------- SWIPE (NOT ON IMAGES) ---------------- */

let startX = 0;
let currentX = 0;
let isDragging = false;
let isSwipingCard = false;

card.addEventListener("touchstart", (e) => {
  if (e.target.closest(".images")) {
    isSwipingCard = false;
    return;
  }

  startX = e.touches[0].clientX;
  isDragging = true;
  isSwipingCard = true;
});

card.addEventListener("touchmove", (e) => {
  if (!isDragging || !isSwipingCard) return;

  currentX = e.touches[0].clientX;
  let diff = currentX - startX;
  card.style.transform =
    `translateX(${diff}px) rotate(${diff * 0.05}deg)`;
});

card.addEventListener("touchend", async () => {
  if (!isDragging || !isSwipingCard) return;

  isDragging = false;
  isSwipingCard = false;

  let diff = currentX - startX;

  if (diff > 120) await like();
  else if (diff < -120) await dislike();

  card.style.transition = "0.3s";
  card.style.transform = "translateX(0px)";
  setTimeout(() => card.style.transition = "0s", 300);
});

/* ---------------- LIKE / DISLIKE ---------------- */

window.like = async function () {
  const likedUser = users[currentIndex];

  await set(ref(db, "likes/" + currentUser.uid + "/" + likedUser.uid), true);

  const reciprocal = await get(
    ref(db, "likes/" + likedUser.uid + "/" + currentUser.uid)
  );

  if (reciprocal.exists()) {
    await set(ref(db, "matches/" + currentUser.uid + "/" + likedUser.uid), true);
    await set(ref(db, "matches/" + likedUser.uid + "/" + currentUser.uid), true);
    alert("It's a match!");
  }

  nextUser();
};

window.dislike = async function () {
  const dislikedUser = users[currentIndex];

  await set(ref(db, "dislikes/" + currentUser.uid + "/" + dislikedUser.uid), true);
  nextUser();
};

function nextUser() {
  currentIndex++;
  if (currentIndex >= users.length) {
    card.style.display = "none";
    document.getElementById("noUsersMessage").style.display = "block";
    return;
  }
  showUser();
}

/* ---------------- MATCH LIST ---------------- */

function loadMatches() {
  const matchesRef = ref(db, "matches/" + currentUser.uid);

  onValue(matchesRef, async (snapshot) => {
    const container = document.getElementById("matchList");
    container.innerHTML = "";

    if (!snapshot.exists()) return;

    for (let uid of Object.keys(snapshot.val())) {
      const userSnap = await get(ref(db, "users/" + uid));
      if (userSnap.exists()) {
        const div = document.createElement("div");
        div.className = "match-item";
        div.innerText = userSnap.val().name;
        container.appendChild(div);
      }
    }
  });
}
</script>

</body>
</html>
