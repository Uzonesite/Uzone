<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Uzone • Umotives</title>

  <link rel="icon" type="image/png" href="logo.png" />
  <meta name="color-scheme" content="dark light" />

  <style>
    :root{
      --accent:#b00b55;
      --bg:#0b0b10;
      --border: rgba(255,255,255,.08);
      --card: rgba(255,255,255,.06);
      --muted: rgba(255,255,255,.6);
      --muted2: rgba(255,255,255,.45);
      --shadow: 0 10px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --gap: 16px;
      --max: 1100px;
      --glass: saturate(140%) blur(10px);
      --ok: #12b76a;
      --warn:#f79009;
      --bad:#f04438;
    }
    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(800px 500px at 15% -10%, rgba(176,11,85,.18), transparent 55%),
        radial-gradient(700px 450px at 110% 5%, rgba(0,180,255,.12), transparent 55%),
        radial-gradient(600px 350px at 40% 110%, rgba(170,255,90,.10), transparent 60%),
        var(--bg);
      color: rgba(255,255,255,.92);
    }
    a{ color:inherit; }
    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 22px 16px 44px;
    }

    /* Top bar */
    .top{
      position: sticky;
      top: 0;
      z-index: 20;
      padding-top: 10px;
      padding-bottom: 10px;
      margin-left: -16px;
      margin-right: -16px;
      padding-left: 16px;
      padding-right: 16px;
      background: linear-gradient(to bottom, rgba(11,11,16,.88), rgba(11,11,16,.55), rgba(11,11,16,0));
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
    }
    .topRow{
      display:flex;
      align-items:center;
      gap: 14px;
      justify-content: space-between;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      text-decoration:none;
      user-select:none;
    }
    .logo{
      width:42px;height:42px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(176,11,85,.95), rgba(0,180,255,.35));
      box-shadow: 0 10px 30px rgba(176,11,85,.22);
      display:grid;
      place-items:center;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
    }
    .logo img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }
    .brandTxt{
      display:flex;
      flex-direction:column;
      line-height: 1.05;
    }
    .brandTxt .t1{
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 15px;
    }
    .brandTxt .t2{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* Auth chip */
    .chip{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .chip .avatar{
      width:30px; height:30px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      display:grid;
      place-items:center;
      font-weight:800;
      color: rgba(255,255,255,.85);
      font-size: 12px;
    }
    .chip .avatar img{
      width:100%;height:100%;
      object-fit: cover;
      display:block;
    }
    .chip .who{
      display:flex;
      flex-direction:column;
      line-height:1.05;
      max-width: 220px;
    }
    .chip .who .name{
      font-size: 13px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chip .who .email{
      font-size: 11px;
      color: var(--muted2);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }
    .btn{
      border: 0;
      border-radius: 999px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 750;
      letter-spacing:.2px;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      text-decoration:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(176,11,85,.95), rgba(176,11,85,.70));
      color: white;
      box-shadow: 0 14px 35px rgba(176,11,85,.22);
      border: 1px solid rgba(255,255,255,.12);
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
    }
    .btn.small{
      padding: 8px 12px;
      font-size: 12px;
    }
    .btn.danger{
      background: rgba(240,68,56,.12);
      border: 1px solid rgba(240,68,56,.30);
      color: rgba(255,255,255,.92);
    }

    /* Filters */
    .filters{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      margin-top: 14px;
    }
    .search{
      flex: 1 1 320px;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .search input{
      flex:1;
      background: transparent;
      border:0;
      outline: none;
      color: rgba(255,255,255,.92);
      font-size: 14px;
    }
    .pillRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .toggle{
      display:flex;
      gap: 8px;
      align-items:center;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.90);
      cursor:pointer;
      user-select:none;
      font-size: 13px;
      font-weight: 650;
    }
    .toggle input{ accent-color: var(--accent); }

    /* Grid */
    .grid{
      margin-top: 18px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--gap);
    }
    .card{
      grid-column: span 6;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      position:relative;
    }
    .card:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.16);
      background: rgba(255,255,255,.075);
    }
    @media (max-width: 920px){
      .card{ grid-column: span 12; }
    }
    .hero{
      height: 140px;
      position:relative;
      background:
        radial-gradient(650px 300px at 10% 25%, rgba(176,11,85,.35), transparent 60%),
        radial-gradient(650px 350px at 110% 15%, rgba(0,180,255,.22), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .hero img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      opacity:.92;
    }
    .badge{
      position:absolute;
      left: 12px;
      top: 12px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .badge .dot{
      width: 9px; height: 9px;
      border-radius: 999px;
      background: var(--ok);
      box-shadow: 0 0 0 4px rgba(18,183,106,.14);
    }
    .badge .dot.closed{ background: var(--bad); box-shadow: 0 0 0 4px rgba(240,68,56,.14); }
    .badge .dot.soon{ background: var(--warn); box-shadow: 0 0 0 4px rgba(247,144,9,.14); }

    .content{
      padding: 14px 14px 16px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .titleRow{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content: space-between;
    }
    .title{
      font-size: 16px;
      font-weight: 850;
      letter-spacing: .2px;
      margin:0;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
    }
    .meta .sep{
      opacity:.35;
    }
    .desc{
      margin:0;
      color: rgba(255,255,255,.82);
      font-size: 13px;
      line-height: 1.45;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }
    .tags{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 2px;
    }
    .tag{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      color: rgba(255,255,255,.88);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
    }

    .actions{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      margin-top: 6px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.08);
    }
    .leftActs{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .rightActs{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .mini{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    .mini b{
      color: rgba(255,255,255,.92);
    }

    .estRow{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 2px;
    }
    .estPill{
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.86);
    }
    .estPill b{ color: rgba(255,255,255,.96); }

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      display:none;
      align-items: flex-end;
      justify-content: center;
      z-index: 80;
    }
    .modal.open{ display:flex; }
    .overlay{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .sheet{
      position:relative;
      width: min(780px, 96vw);
      max-height: 88vh;
      overflow:auto;
      background: rgba(20,20,28,.92);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 22px 22px 16px 16px;
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      margin-bottom: 14px;
    }
    .sheetHead{
      position: sticky;
      top:0;
      z-index: 2;
      padding: 14px 14px 10px;
      background: rgba(20,20,28,.92);
      border-bottom: 1px solid rgba(255,255,255,.10);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 14px;
    }
    .sheetHead h2{
      margin:0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .sheetBody{
      padding: 12px 14px 16px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      color: rgba(255,255,255,.84);
      font-size: 13px;
    }
    .row .k{ color: var(--muted2); }
    .memberList{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .member{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .member .mAva{
      width: 34px; height: 34px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      display:grid;
      place-items:center;
      font-weight:800;
      font-size: 12px;
      color: rgba(255,255,255,.85);
      flex: 0 0 auto;
    }
    .member .mAva img{ width:100%;height:100%;object-fit:cover;display:block; }
    .member .mName{
      font-weight: 800;
      font-size: 13px;
      line-height:1.15;
    }
    .member .mSub{
      font-size: 11px;
      color: var(--muted2);
      margin-top: 2px;
    }

    .empty{
      padding: 26px 14px;
      text-align:center;
      color: var(--muted);
      border: 1px dashed rgba(255,255,255,.16);
      border-radius: var(--radius);
      grid-column: 1 / -1;
      background: rgba(255,255,255,.03);
    }
    .foot{
      margin-top: 18px;
      color: rgba(255,255,255,.55);
      font-size: 12px;
      text-align:center;
    }

    /* subtle icons */
    .ico{
      width: 16px;
      height: 16px;
      display:inline-block;
      opacity:.92;
    }
    .ico svg{ width:100%;height:100%; display:block; }

    .srOnly{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="top">
      <div class="topRow">
        <a class="brand" href="home.html">
          <div class="logo">
            <img src="logo.png" alt="Uzone"/>
          </div>
          <div class="brandTxt">
            <div class="t1">Uzone</div>
            <div class="t2">Events</div>
          </div>
        </a>

        <div class="chip" id="authChip">
          <div class="avatar" id="chipAvatar">?</div>
          <div class="who">
            <div class="name" id="chipName">Not signed in</div>
            <div class="email" id="chipEmail">—</div>
          </div>
          <button class="btn small ghost" id="logoutBtn" style="display:none;">Log out</button>
          <a class="btn small primary" id="loginBtn" href="index.html" style="display:none;">Log in</a>
        </div>
      </div>

      <div class="filters">
        <div class="search">
          <span class="ico" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" opacity=".9"/>
              <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".9"/>
            </svg>
          </span>
          <input id="q" placeholder="Search events by title, host, tags…" autocomplete="off" />
          <button class="btn small ghost" id="clearQ" title="Clear">Clear</button>
        </div>

        <div class="pillRow">
          <label class="toggle" title="Show only events you’re going to">
            <input type="checkbox" id="onlyGoing" />
            Only going
          </label>
          <label class="toggle" title="Include past events">
            <input type="checkbox" id="includePast" />
            Include past
          </label>
          <button class="btn ghost" id="refreshBtn">Refresh</button>
        </div>
      </div>
    </div>

    <div class="grid" id="grid">
      <div class="empty" id="loadingBox">Loading events…</div>
    </div>

    <div class="foot">Uzone • Umotives</div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="overlay" id="overlay"></div>
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <div class="sheetHead">
        <div style="min-width:0">
          <h2 id="sheetTitle">Event</h2>
          <div class="meta" id="sheetMeta"></div>
        </div>
        <button class="btn ghost small" id="closeBtn">Close</button>
      </div>
      <div class="sheetBody">
        <p class="desc" id="sheetDesc" style="-webkit-line-clamp:unset;"></p>
        <div class="row" id="sheetInfo"></div>
        <div class="row" id="sheetEst"></div>
        <div class="row" id="sheetAddr"></div>

        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div class="mini">Attending: <b id="sheetCount">—</b></div>
          <button class="btn small primary" id="sheetGoingBtn" style="display:none;">Going</button>
        </div>

        <div>
          <div style="font-weight:900; margin: 6px 0 10px;">Attendees</div>
          <div class="memberList" id="sheetMembers"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      getDocs,
      getDoc,
      setDoc,
      deleteDoc,
      query,
      orderBy,
      serverTimestamp,
      limit
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const grid = document.getElementById("grid");
    const loadingBox = document.getElementById("loadingBox");
    const qEl = document.getElementById("q");
    const clearQBtn = document.getElementById("clearQ");
    const onlyGoingEl = document.getElementById("onlyGoing");
    const includePastEl = document.getElementById("includePast");
    const refreshBtn = document.getElementById("refreshBtn");

    const modal = document.getElementById("modal");
    const overlay = document.getElementById("overlay");
    const closeBtn = document.getElementById("closeBtn");
    const sheetTitle = document.getElementById("sheetTitle");
    const sheetMeta = document.getElementById("sheetMeta");
    const sheetDesc = document.getElementById("sheetDesc");
    const sheetInfo = document.getElementById("sheetInfo");
    const sheetEst = document.getElementById("sheetEst");
    const sheetAddr = document.getElementById("sheetAddr");
    const sheetCount = document.getElementById("sheetCount");
    const sheetMembers = document.getElementById("sheetMembers");
    const sheetGoingBtn = document.getElementById("sheetGoingBtn");

    const authChip = document.getElementById("authChip");
    const chipAvatar = document.getElementById("chipAvatar");
    const chipName = document.getElementById("chipName");
    const chipEmail = document.getElementById("chipEmail");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginBtn = document.getElementById("loginBtn");

    let currentUser = null;
    let allEvents = [];
    let eventsById = new Map();
    let goingMap = new Map();    // eventId -> boolean (current user in members)
    // PRIVATE apply uses applications
    const appliedMap = new Map();  // eventId -> boolean (has application)

    // cache: eventId -> members array (with resolved names)
    const membersCache = new Map();
    // cache: eventId -> number (members count)
    const attendingCountCache = new Map();
    // users/{uid} name cache
    const userNameCache = new Map();

    // gender cache: uid -> "Male" | "Female" | "" (missing/other)
    const userGenderCache = new Map();
    // cache: eventId -> computed attendee ratio text "girls:boys" like "2:1"
    const attendeeRatioCache = new Map();

    function gcd(a, b){
      a = Math.abs(a); b = Math.abs(b);
      while (b){ const t = b; b = a % b; a = t; }
      return a || 1;
    }

    function toGirlsBoysRatioText(girls, boys){
      const g = Number(girls) || 0;
      const b = Number(boys) || 0;

      // If nobody has gender set
      if (g === 0 && b === 0) return "—";

      // Keep zeros if one side is zero
      if (g === 0 || b === 0) return `${g}:${b}`;

      const d = gcd(g, b);
      return `${Math.round(g / d)}:${Math.round(b / d)}`;
    }

    async function resolveGender(uid){
      if (!uid) return "";
      if (userGenderCache.has(uid)) return userGenderCache.get(uid) || "";

      try{
        const uSnap = await getDoc(doc(db, "users", uid));
        if (uSnap.exists()){
          const g = (uSnap.data()?.gender || "").toString().trim();
          const val = (g === "Male" || g === "Female") ? g : "";
          userGenderCache.set(uid, val);
          return val;
        }
      }catch{}

      userGenderCache.set(uid, "");
      return "";
    }

    // small concurrency limiter so we don’t spam Firestore reads
    async function mapWithConcurrency(items, limitN, fn){
      const out = new Array(items.length);
      let i = 0;

      const workers = Array.from({ length: Math.min(limitN, items.length) }, async () => {
        while (i < items.length){
          const idx = i++;
          out[idx] = await fn(items[idx], idx);
        }
      });

      await Promise.all(workers);
      return out;
    }

    async function ensureAttendeeRatio(eventId, el){
      if (!eventId || !el) return;

      if (attendeeRatioCache.has(eventId)){
        el.textContent = attendeeRatioCache.get(eventId) || "—";
        return;
      }

      el.textContent = "…";
      try{
        const snap = await getDocs(query(collection(db, "events", eventId, "members"), limit(500)));
        const uids = snap.docs.map(d => d.id);

        const genders = await mapWithConcurrency(uids, 20, async (uid) => resolveGender(uid));

        let girls = 0, boys = 0;
        for (const g of genders){
          if (g === "Female") girls++;
          else if (g === "Male") boys++;
        }

        const ratioText = toGirlsBoysRatioText(girls, boys); // girls:boys
        attendeeRatioCache.set(eventId, ratioText);
        el.textContent = ratioText;
      }catch{
        el.textContent = "—";
      }
    }

    function esc(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function isFiniteNum(v){
      const n = Number(v);
      return Number.isFinite(n);
    }
    function clamp10(v){
      const n = Number(v);
      if (!Number.isFinite(n)) return 0;
      return Math.max(0, Math.min(10, n));
    }

    function fmtDate(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts));
        return d.toLocaleString(undefined, { weekday:"short", month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });
      }catch{
        return "—";
      }
    }

    function nowMs(){ return Date.now(); }

    function isPast(ev){
      const end = ev?.endTime?.toDate ? ev.endTime.toDate().getTime()
        : ev?.endTime ? new Date(ev.endTime).getTime() : null;
      const start = ev?.startTime?.toDate ? ev.startTime.toDate().getTime()
        : ev?.startTime ? new Date(ev.startTime).getTime() : null;
      const t = end ?? start;
      if (!t) return false;
      return t < nowMs();
    }

    function statusDot(ev){
      const start = ev?.startTime?.toDate ? ev.startTime.toDate().getTime()
        : ev?.startTime ? new Date(ev.startTime).getTime() : null;
      const end = ev?.endTime?.toDate ? ev.endTime.toDate().getTime()
        : ev?.endTime ? new Date(ev.endTime).getTime() : null;

      const tNow = nowMs();
      if (end && end < tNow) return "closed";
      if (start && start > tNow && start - tNow < 36*60*60*1000) return "soon";
      return "open";
    }

    async function loadGoingMap(){
      goingMap = new Map();
      appliedMap.clear();
      if (!currentUser) return;

      // current user membership per event — we check in members subcollection
      // This is bounded by events count (small), so we do a cheap per-event check later lazily.
      // Here we just clear and let ensureGoingBadge compute when rendering.
    }

    async function ensureGoingBadge(eventId, el){
      if (!currentUser || !eventId || !el) return;
      if (goingMap.has(eventId)){
        el.textContent = goingMap.get(eventId) ? "Going" : "";
        el.style.display = goingMap.get(eventId) ? "" : "none";
        return;
      }
      try{
        const mSnap = await getDoc(doc(db, "events", eventId, "members", currentUser.uid));
        const isGoing = mSnap.exists();
        goingMap.set(eventId, isGoing);
        el.textContent = isGoing ? "Going" : "";
        el.style.display = isGoing ? "" : "none";
      }catch{
        goingMap.set(eventId, false);
        el.textContent = "";
        el.style.display = "none";
      }
    }

    async function ensureApplied(eventId, inviteOnly, el){
      if (!currentUser || !eventId || !inviteOnly || !el) return;
      if (appliedMap.has(eventId)){
        const applied = appliedMap.get(eventId) === true;
        el.textContent = applied ? "Applied" : "";
        el.style.display = applied ? "" : "none";
        return;
      }
      try{
        const aSnap = await getDoc(doc(db, "events", eventId, "applications", currentUser.uid));
        const applied = aSnap.exists();
        appliedMap.set(eventId, applied);
        el.textContent = applied ? "Applied" : "";
        el.style.display = applied ? "" : "none";
      }catch{
        appliedMap.set(eventId, false);
        el.textContent = "";
        el.style.display = "none";
      }
    }

    async function ensureAttendingCount(eventId, el){
      if (!eventId || !el) return;
      if (attendingCountCache.has(eventId)){
        el.textContent = attendingCountCache.get(eventId);
        return;
      }
      el.textContent = "…";
      try{
        const snap = await getDocs(query(collection(db, "events", eventId, "members"), limit(500)));
        const n = snap.size;
        attendingCountCache.set(eventId, n);
        el.textContent = n;
      }catch{
        el.textContent = "—";
      }
    }

    async function resolveName(uid){
      if (!uid) return "Unknown";
      if (userNameCache.has(uid)) return userNameCache.get(uid);
      try{
        const uSnap = await getDoc(doc(db, "users", uid));
        if (uSnap.exists()){
          const data = uSnap.data() || {};
          const nm = (data.displayName || data.name || data.username || "").toString().trim();
          const out = nm || "User";
          userNameCache.set(uid, out);
          return out;
        }
      }catch{}
      userNameCache.set(uid, "User");
      return "User";
    }

    function initials(name){
      const s = (name||"").trim();
      if (!s) return "?";
      const parts = s.split(/\s+/).slice(0,2);
      return parts.map(p => p[0]?.toUpperCase() || "").join("") || "?";
    }

    async function getMembers(eventId){
      if (membersCache.has(eventId)) return membersCache.get(eventId);
      try{
        const snap = await getDocs(query(collection(db, "events", eventId, "members"), orderBy("createdAt","desc"), limit(200)));
        const arr = await Promise.all(snap.docs.map(async d => {
          const data = d.data() || {};
          const uid = d.id;
          const name = (data.name || "").toString().trim() || await resolveName(uid);
          const photoURL = (data.photoURL || "").toString();
          const when = data.createdAt ? fmtDate(data.createdAt) : "";
          return { uid, name, photoURL, when };
        }));
        membersCache.set(eventId, arr);
        return arr;
      }catch{
        membersCache.set(eventId, []);
        return [];
      }
    }

    async function fetchEvents(){
      loadingBox.textContent = "Loading events…";
      loadingBox.style.display = "";
      grid.innerHTML = "";
      grid.appendChild(loadingBox);

      try{
        const snap = await getDocs(query(collection(db, "events"), orderBy("startTime","asc"), limit(200)));
        allEvents = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        eventsById = new Map(allEvents.map(ev => [ev.id, ev]));
      }catch(err){
        console.error(err);
        allEvents = [];
        eventsById = new Map();
      }
      applySearch();
    }

    function applySearch(){
      const q = (qEl.value || "").trim().toLowerCase();
      const onlyGoing = onlyGoingEl.checked;
      const includePast = includePastEl.checked;

      let list = allEvents.slice();

      if (!includePast){
        list = list.filter(ev => !isPast(ev));
      }

      if (q){
        list = list.filter(ev => {
          const title = (ev.title || "").toString().toLowerCase();
          const host = (ev.hostName || ev.host || "").toString().toLowerCase();
          const tags = Array.isArray(ev.tags) ? ev.tags.join(" ").toLowerCase() : "";
          const desc = (ev.description || "").toString().toLowerCase();
          return title.includes(q) || host.includes(q) || tags.includes(q) || desc.includes(q);
        });
      }

      if (onlyGoing){
        // Only keep events where goingMap is true; if unknown yet, we’ll lazily fill as cards render.
        // Here we optimistically keep all; render() will hide when confirmed false by ensureGoingBadge.
      }

      render(list);
    }

    function render(list){
      grid.innerHTML = "";
      if (!list.length){
        const e = document.createElement("div");
        e.className = "empty";
        e.textContent = "No events found.";
        grid.appendChild(e);
        return;
      }

      for (const ev of list){
        const inviteOnly = !!ev.inviteOnly;
        const tags = Array.isArray(ev.tags) ? ev.tags : [];
        const start = ev.startTime ? fmtDate(ev.startTime) : "—";
        const end = ev.endTime ? fmtDate(ev.endTime) : "";
        const where = (ev.locationName || ev.location || "").toString().trim();
        const host = (ev.hostName || ev.host || "").toString().trim();
        const cover = (ev.coverURL || ev.cover || ev.imageURL || "").toString().trim();

        const dot = statusDot(ev);
        const dotLabel = dot === "closed" ? "Past" : (dot === "soon" ? "Soon" : "Open");

        const estAtt = (ev.sizeEstimate ?? ev.estimatedAttendance ?? ev.estimated ?? ev.size ?? null);
        const estRatio = (ev.ratio ?? ev.estimatedRatio ?? null);

        // Only show ratio-related pills if the event has an estimated ratio
        const showRatio = !!estRatio;

        const estimatesHtml = (estAtt || showRatio) ? `
          <div class="estRow">
            ${estAtt ? `<span class="estPill">Estimated Attendance: <b>${esc(estAtt)}</b></span>` : ``}
            ${showRatio ? `
              <span class="estPill">Estimated ratio: <b>${esc(estRatio)}</b></span>
              <span class="estPill">Attendee ratio (girls:boys): <b><span class="attRatio" data-ev="${esc(ev.id)}">—</span></b></span>
            ` : ``}
          </div>
        ` : ``;

        const whenText = inviteOnly ? "Invite-only" : "Public";
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="hero">
            ${cover ? `<img src="${esc(cover)}" alt="${esc(ev.title||"Event")}">` : ``}
            <div class="badge">
              <span class="dot ${dot}"></span>
              ${dotLabel}
              <span style="opacity:.55">•</span>
              ${whenText}
            </div>
          </div>

          <div class="content">
            <div class="titleRow">
              <h3 class="title">${esc(ev.title || "Untitled Event")}</h3>

              <div style="display:flex; gap:8px; align-items:center;">
                <span class="tag" style="display:none;" data-going="${esc(ev.id)}">Going</span>
                <span class="tag" style="display:none;" data-applied="${esc(ev.id)}">Applied</span>
              </div>
            </div>

            <div class="meta">
              <span>${esc(start)}</span>
              ${end ? `<span class="sep">•</span><span>${esc(end)}</span>` : ``}
              ${where ? `<span class="sep">•</span><span>${esc(where)}</span>` : ``}
              ${host ? `<span class="sep">•</span><span>Host: ${esc(host)}</span>` : ``}
            </div>

            ${estimatesHtml}

            <p class="desc">${esc(ev.description || "")}</p>

            <div class="tags">
              ${tags.slice(0,5).map(t => `<span class="tag">${esc(t)}</span>`).join("")}
            </div>

            <div class="actions">
              <div class="leftActs">
                <div class="mini">Attending: <b class="attCount" data-ev="${esc(ev.id)}">—</b></div>
              </div>

              <div class="rightActs">
                <button class="btn small ghost mapBtn" data-id="${esc(ev.id)}" data-lat="${esc(ev.lat ?? "")}" data-lng="${esc(ev.lng ?? "")}">Map</button>
                <button class="btn small ghost detailsBtn" data-id="${esc(ev.id)}">Details</button>
                <button class="btn small primary goingBtn" data-id="${esc(ev.id)}" style="display:none;">Going</button>
              </div>
            </div>
          </div>
        `;

        // attending count
        const attEl = card.querySelector('.attCount');
        if (attEl) ensureAttendingCount(ev.id, attEl);

        // attendee ratio (only rendered when event has an estimated ratio)
        const ratioEl = card.querySelector('.attRatio');
        if (ratioEl) ensureAttendeeRatio(ev.id, ratioEl);

        grid.appendChild(card);

        const mapBtn = card.querySelector(".mapBtn");
        if (mapBtn){
          mapBtn.addEventListener("click", (e) => {
            e.preventDefault(); e.stopPropagation();
            const id = mapBtn.dataset.id || "";
            const lat = mapBtn.dataset.lat || "";
            const lng = mapBtn.dataset.lng || "";
            if (lat && lng){
              window.open(`https://www.google.com/maps?q=${encodeURIComponent(lat + "," + lng)}`, "_blank");
            } else {
              const evv = eventsById.get(id);
              const addr = (evv?.address || evv?.locationAddress || "").toString().trim();
              if (addr){
                window.open(`https://www.google.com/maps?q=${encodeURIComponent(addr)}`, "_blank");
              }
            }
          });
        }

        const detailsBtn = card.querySelector(".detailsBtn");
        if (detailsBtn){
          detailsBtn.addEventListener("click", async (e) => {
            e.preventDefault(); e.stopPropagation();
            await openDetails(ev.id);
          });
        }

        const goingBtn = card.querySelector(".goingBtn");
        if (goingBtn){
          // show only if logged in
          goingBtn.style.display = currentUser ? "" : "none";
          goingBtn.addEventListener("click", async (e) => {
            e.preventDefault(); e.stopPropagation();
            await toggleGoing(ev.id, inviteOnly, goingBtn);
            await ensureGoingUI(ev.id, inviteOnly, card, goingBtn);
          });
        }

        // badges
        const goingBadge = card.querySelector(`[data-going="${ev.id}"]`);
        const appliedBadge = card.querySelector(`[data-applied="${ev.id}"]`);
        if (goingBadge) ensureGoingBadge(ev.id, goingBadge);
        if (appliedBadge) ensureApplied(ev.id, inviteOnly, appliedBadge);

        // Hide cards when onlyGoing enabled and user not going
        if (onlyGoingEl.checked && currentUser){
          // If we don't know yet, we keep it and later hide once resolved
          ensureGoingBadge(ev.id, goingBadge).then(() => {
            const isGoing = goingMap.get(ev.id) === true;
            card.style.display = isGoing ? "" : "none";
          });
        }

        // Update button state after badge resolves
        if (goingBtn){
          ensureGoingUI(ev.id, inviteOnly, card, goingBtn);
        }
      }
    }

    async function ensureGoingUI(eventId, inviteOnly, card, btnEl){
      if (!btnEl) return;
      if (!currentUser){
        btnEl.style.display = "none";
        return;
      }
      btnEl.style.display = "";
      if (!goingMap.has(eventId)){
        try{
          const mSnap = await getDoc(doc(db, "events", eventId, "members", currentUser.uid));
          goingMap.set(eventId, mSnap.exists());
        }catch{
          goingMap.set(eventId, false);
        }
      }
      const already = goingMap.get(eventId) === true;
      btnEl.textContent = already ? "Leave" : (inviteOnly ? "Apply / Join" : "Going");
      btnEl.classList.toggle("danger", already);
    }

    async function toggleGoing(eventId, inviteOnly, btnEl){
      if (!currentUser || !eventId) return;
      btnEl.disabled = true;

      try{
        const mRef = doc(db, "events", eventId, "members", currentUser.uid);
        const already = goingMap.get(eventId) === true;

        if (already){
          await deleteDoc(mRef);
          goingMap.set(eventId, false);

          if (inviteOnly){
            try{ await deleteDoc(doc(db, "events", eventId, "applications", currentUser.uid)); }catch{}
            appliedMap.set(eventId, false);
          }
  
        } else {
          await setDoc(mRef, {
            uid: currentUser.uid,
            name: (currentUser.displayName || "").toString(),
            photoURL: (currentUser.photoURL || "").toString(),
            createdAt: serverTimestamp()
          }, { merge: true });
          goingMap.set(eventId, true);
        }

        membersCache.delete(eventId);

        // refresh counts/ratios quickly
        attendingCountCache.delete(eventId);
        attendeeRatioCache.delete(eventId);

        const attEl = document.querySelector(`.attCount[data-ev="${eventId}"]`);
        if (attEl) ensureAttendingCount(eventId, attEl);

        const ratioEl = document.querySelector(`.attRatio[data-ev="${eventId}"]`);
        if (ratioEl) ensureAttendeeRatio(eventId, ratioEl);

        applySearch();
      } catch(err){
        console.error(err);
      } finally {
        btnEl.disabled = false;
      }
    }

    function openModal(){
      modal.classList.add("open");
      document.body.style.overflow = "hidden";
    }
    function closeModal(){
      modal.classList.remove("open");
      document.body.style.overflow = "";
    }

    overlay.addEventListener("click", closeModal);
    closeBtn.addEventListener("click", closeModal);
    window.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeModal(); });

    async function openDetails(eventId){
      const ev = eventsById.get(eventId);
      if (!ev) return;

      sheetTitle.textContent = ev.title || "Event";
      const inviteOnly = !!ev.inviteOnly;
      const start = ev.startTime ? fmtDate(ev.startTime) : "—";
      const end = ev.endTime ? fmtDate(ev.endTime) : "";
      const where = (ev.locationName || ev.location || "").toString().trim();
      const host = (ev.hostName || ev.host || "").toString().trim();
      sheetMeta.innerHTML = `
        <span>${esc(start)}</span>
        ${end ? `<span class="sep">•</span><span>${esc(end)}</span>` : ``}
        ${where ? `<span class="sep">•</span><span>${esc(where)}</span>` : ``}
        ${host ? `<span class="sep">•</span><span>Host: ${esc(host)}</span>` : ``}
        <span class="sep">•</span><span>${inviteOnly ? "Invite-only" : "Public"}</span>
      `;

      sheetDesc.textContent = (ev.description || "").toString();

      // Info
      const price = (ev.price ?? ev.cost ?? "").toString().trim();
      const age = (ev.age ?? ev.ageLimit ?? "").toString().trim();
      const dress = (ev.dressCode ?? "").toString().trim();
      sheetInfo.innerHTML = `
        ${price ? `<span><span class="k">Price:</span> ${esc(price)}</span>` : ``}
        ${age ? `<span><span class="k">Age:</span> ${esc(age)}</span>` : ``}
        ${dress ? `<span><span class="k">Dress:</span> ${esc(dress)}</span>` : ``}
      `;

      // Estimates (same rule: only show ratio when estimated ratio exists)
      const estAtt = (ev.sizeEstimate ?? ev.estimatedAttendance ?? ev.estimated ?? ev.size ?? null);
      const estRatio = (ev.ratio ?? ev.estimatedRatio ?? null);
      const showRatio = !!estRatio;

      sheetEst.innerHTML = `
        ${estAtt ? `<span class="estPill">Estimated Attendance: <b>${esc(estAtt)}</b></span>` : ``}
        ${showRatio ? `<span class="estPill">Estimated ratio: <b>${esc(estRatio)}</b></span>` : ``}
        ${showRatio ? `<span class="estPill">Attendee ratio (girls:boys): <b><span class="attRatio" data-ev="${esc(ev.id)}">—</span></b></span>` : ``}
      `;

      // Address
      const addr = (ev.address || ev.locationAddress || "").toString().trim();
      const lat = ev.lat ?? "";
      const lng = ev.lng ?? "";
      sheetAddr.innerHTML = `
        ${addr ? `<span><span class="k">Address:</span> ${esc(addr)}</span>` : ``}
        ${(lat && lng) ? `<a class="btn small ghost" style="text-decoration:none;" href="https://www.google.com/maps?q=${encodeURIComponent(lat + "," + lng)}" target="_blank" rel="noreferrer">Open map</a>` : ``}
        ${(!lat && !lng && addr) ? `<a class="btn small ghost" style="text-decoration:none;" href="https://www.google.com/maps?q=${encodeURIComponent(addr)}" target="_blank" rel="noreferrer">Open map</a>` : ``}
      `;

      // Count + members
      sheetCount.textContent = "…";
      sheetMembers.innerHTML = `<div class="empty" style="margin:0;">Loading attendees…</div>`;

      await ensureAttendingCount(eventId, sheetCount);

      // attendee ratio in sheet (only exists if estimated ratio exists)
      const ratioEl = sheetEst.querySelector('.attRatio');
      if (ratioEl) ensureAttendeeRatio(eventId, ratioEl);

      const members = await getMembers(eventId);
      sheetCount.textContent = members.length;

      sheetMembers.innerHTML = members.length ? members.map(m => `
        <div class="member">
          <div class="mAva">${m.photoURL ? `<img src="${esc(m.photoURL)}" alt="${esc(m.name)}">` : esc(initials(m.name))}</div>
          <div style="min-width:0">
            <div class="mName">${esc(m.name)}</div>
            <div class="mSub">${m.when ? `Joined ${esc(m.when)}` : ``}</div>
          </div>
        </div>
      `).join("") : `<div class="empty" style="margin:0;">No attendees yet.</div>`;

      // Button
      if (currentUser){
        sheetGoingBtn.style.display = "";
        await ensureGoingUI(eventId, inviteOnly, null, sheetGoingBtn);
        sheetGoingBtn.onclick = async ()=>{
          await toggleGoing(eventId, inviteOnly, sheetGoingBtn);
          await ensureGoingUI(eventId, inviteOnly, null, sheetGoingBtn);

          // refresh the sheet list and counts quickly
          membersCache.delete(eventId);
          attendingCountCache.delete(eventId);
          attendeeRatioCache.delete(eventId);

          await ensureAttendingCount(eventId, sheetCount);

          const ratioEl2 = sheetEst.querySelector('.attRatio');
          if (ratioEl2) ensureAttendeeRatio(eventId, ratioEl2);

          const mem2 = await getMembers(eventId);
          sheetCount.textContent = mem2.length;
          sheetMembers.innerHTML = mem2.length ? mem2.map(m => `
            <div class="member">
              <div class="mAva">${m.photoURL ? `<img src="${esc(m.photoURL)}" alt="${esc(m.name)}">` : esc(initials(m.name))}</div>
              <div style="min-width:0">
                <div class="mName">${esc(m.name)}</div>
                <div class="mSub">${m.when ? `Joined ${esc(m.when)}` : ``}</div>
              </div>
            </div>
          `).join("") : `<div class="empty" style="margin:0;">No attendees yet.</div>`;

          applySearch();
        };
      } else {
        sheetGoingBtn.style.display = "none";
      }

      openModal();
    }

    // UI listeners
    clearQBtn.addEventListener("click", ()=>{
      qEl.value = "";
      applySearch();
      qEl.focus();
    });
    qEl.addEventListener("input", ()=> applySearch());
    onlyGoingEl.addEventListener("change", ()=> applySearch());
    includePastEl.addEventListener("change", ()=> applySearch());
    refreshBtn.addEventListener("click", ()=> fetchEvents());

    // Auth UI
    logoutBtn.addEventListener("click", async ()=>{
      try{ await signOut(auth); }catch(e){ console.error(e); }
    });

    function setChip(user){
      if (!user){
        chipAvatar.textContent = "?";
        chipAvatar.innerHTML = "?";
        chipName.textContent = "Not signed in";
        chipEmail.textContent = "—";
        logoutBtn.style.display = "none";
        loginBtn.style.display = "";
        return;
      }
      const name = (user.displayName || "User").toString();
      const email = (user.email || "").toString();
      const photo = (user.photoURL || "").toString();

      if (photo){
        chipAvatar.innerHTML = `<img src="${esc(photo)}" alt="${esc(name)}">`;
      } else {
        chipAvatar.textContent = initials(name);
      }
      chipName.textContent = name;
      chipEmail.textContent = email || "—";
      logoutBtn.style.display = "";
      loginBtn.style.display = "none";
    }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;
      setChip(currentUser);
      await loadGoingMap();
      // refresh button visibility and content
      fetchEvents();
    });

    // initial fetch (non-auth)
    fetchEvents();
  </script>
</body>
</html>
