<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Uzone • Messages</title>

<style>
:root{
  --accent:#b00b55;
  --bg:#0b0b10;
  --panel: rgba(255,255,255,.06);
  --border: rgba(255,255,255,.14);
  --text:white;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  font-family: system-ui, sans-serif;
  color:var(--text);
  height:100vh;
  display:flex;
}
.sidebar{
  width:260px;
  border-right:1px solid var(--border);
  overflow-y:auto;
  padding:12px;
}
.matchItem{
  padding:12px;
  border-radius:12px;
  cursor:pointer;
}
.matchItem:hover{
  background:rgba(255,255,255,.05);
}

.chat{
  flex:1;
  display:flex;
  flex-direction:column;
  height:100vh;
}

.chatHeader{
  position:sticky;
  top:0;
  background:var(--bg);
  padding:14px;
  border-bottom:1px solid var(--border);
  font-weight:600;
  z-index:10;
}

.messages{
  flex:1;
  overflow-y:auto;
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.bubble{
  max-width:70%;
  padding:12px 14px;
  border-radius:18px;
  font-size:14px;
  position:relative;
  display:flex;
  flex-direction:column;
  transition:.15s;
}
.bubble:active{
  transform:scale(.98);
}
.me{
  align-self:flex-end;
  background:var(--accent);
}
.them{
  align-self:flex-start;
  background:rgba(255,255,255,.1);
}
.replyPreview{
  font-size:12px;
  opacity:.7;
  margin-bottom:6px;
  border-left:2px solid white;
  padding-left:6px;
}
.timestamp{
  font-size:11px;
  opacity:.7;
  margin-top:6px;
  display:none;
}
.actions{
  display:none;
  gap:8px;
  margin-top:6px;
}
.actions button{
  font-size:11px;
  background:none;
  border:none;
  color:white;
  cursor:pointer;
  opacity:.7;
}

.inputArea{
  position:sticky;
  bottom:0;
  background:var(--bg);
  border-top:1px solid var(--border);
  padding:12px;
  display:flex;
  flex-direction:column;
}

.replyingTo{
  font-size:12px;
  opacity:.8;
  margin-bottom:6px;
  display:none;
}

.replyingTo button{
  background:none;
  border:none;
  color:white;
  cursor:pointer;
}

.inputRow{
  display:flex;
}

.inputRow input{
  flex:1;
  padding:12px;
  border-radius:20px;
  border:none;
  outline:none;
}

.inputRow button{
  margin-left:10px;
  padding:12px 18px;
  border-radius:20px;
  border:none;
  background:var(--accent);
  color:white;
  cursor:pointer;
}

.editInput{
  background:transparent;
  border:none;
  color:white;
  font-size:14px;
  outline:none;
  width:100%;
}
</style>
</head>
<body>

<div class="sidebar" id="matchList"></div>

<div class="chat">
  <div class="chatHeader" id="chatHeader">Select a chat</div>

  <div class="messages" id="messages"></div>

  <div class="inputArea">
    <div class="replyingTo" id="replyingTo">
      Replying... <button id="cancelReply">✕</button>
    </div>
    <div class="inputRow">
      <input id="messageInput" placeholder="Type a message"/>
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  addDoc,
  getDoc,
  getDocs,
  updateDoc,
  deleteDoc,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD_k18vbiBsLhQB7PzgEVT9PEI_30Mu0kg",
  authDomain: "uzone-6148d.firebaseapp.com",
  projectId: "uzone-6148d",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const matchList = document.getElementById("matchList");
const messagesDiv = document.getElementById("messages");
const chatHeader = document.getElementById("chatHeader");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const replyingToDiv = document.getElementById("replyingTo");
const cancelReply = document.getElementById("cancelReply");

let currentUser = null;
let currentChatId = null;
let replyToMessage = null;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  currentUser = user;
  loadMatches();
});

async function loadMatches(){
  const snap = await getDocs(collection(db, "matches"));
  snap.forEach(async (docSnap) => {
    const data = docSnap.data();
    if (data.members.includes(currentUser.uid)) {
      const other = data.members.find(m => m !== currentUser.uid);

      const userSnap = await getDoc(doc(db,"users",other));
      const name = userSnap.exists() ? userSnap.data().name : other;

      const div = document.createElement("div");
      div.className = "matchItem";
      div.textContent = name;
      div.onclick = () => openChat(docSnap.id, name);
      matchList.appendChild(div);
    }
  });
}

function openChat(chatId, name){
  currentChatId = chatId;
  chatHeader.textContent = name;
  messagesDiv.innerHTML = "";

  const q = query(
    collection(db, "chats", chatId, "messages"),
    orderBy("createdAt")
  );

  onSnapshot(q, snap => {
    messagesDiv.innerHTML = "";
    snap.forEach(docSnap => {
      const msg = docSnap.data();
      const bubble = document.createElement("div");
      bubble.className = "bubble " + 
        (msg.senderId === currentUser.uid ? "me" : "them");

      if (msg.replyText) {
        const reply = document.createElement("div");
        reply.className = "replyPreview";
        reply.textContent = msg.replyText;
        bubble.appendChild(reply);
      }

      const text = document.createElement("div");
      text.textContent = msg.text;
      bubble.appendChild(text);

      const time = document.createElement("div");
      time.className = "timestamp";
      time.textContent = msg.createdAt?.toDate().toLocaleString() || "";
      bubble.appendChild(time);

      const actions = document.createElement("div");
      actions.className = "actions";

      const replyBtn = document.createElement("button");
      replyBtn.textContent = "Reply";
      replyBtn.onclick = () => {
        replyToMessage = msg;
        replyingToDiv.style.display = "block";
      };
      actions.appendChild(replyBtn);

      if (msg.senderId === currentUser.uid) {
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.onclick = () => {
          const input = document.createElement("input");
          input.value = msg.text;
          input.className = "editInput";
          bubble.replaceChild(input, text);
          input.focus();

          input.onblur = async () => {
            await updateDoc(
              doc(db,"chats",chatId,"messages",docSnap.id),
              { text: input.value }
            );
          };
        };
        actions.appendChild(editBtn);

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = async () => {
          await deleteDoc(doc(db,"chats",chatId,"messages",docSnap.id));
        };
        actions.appendChild(deleteBtn);
      }

      bubble.appendChild(actions);

      bubble.onclick = () => {
        time.style.display =
          time.style.display === "block" ? "none" : "block";
        actions.style.display =
          actions.style.display === "flex" ? "none" : "flex";
      };

      messagesDiv.appendChild(bubble);
    });

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

sendBtn.onclick = async () => {
  const text = messageInput.value.trim();
  if (!text || !currentChatId) return;

  await addDoc(
    collection(db,"chats",currentChatId,"messages"),
    {
      text,
      senderId: currentUser.uid,
      createdAt: serverTimestamp(),
      replyText: replyToMessage ? replyToMessage.text : null
    }
  );

  messageInput.value="";
  replyToMessage=null;
  replyingToDiv.style.display="none";
};

cancelReply.onclick = () => {
  replyToMessage=null;
  replyingToDiv.style.display="none";
};
</script>
</body>
</html>
